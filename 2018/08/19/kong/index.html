<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Api-Gateway Kong与容器服务 | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Api-Gateway Kong与容器服务</h1><a id="logo" href="/.">xigang's home</a><p class="description">简单不先于复杂，而是在复杂之后</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Api-Gateway Kong与容器服务</h1><div class="post-meta">Aug 19, 2018<span> | </span><span class="category"><a href="/categories/微服务/">微服务</a></span></div><div class="post-content"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>公司的一些团队想将他们的服务已容器的方式进行快速部署交付。对于一些简单的单体应用，直接通过公司的负载均衡就可以了。但是如果想要将多个小的应用(如:人脸检测，图片检测等)最终归类为一个大的应用来对外提供服务的话，就需要网关来做这件事情。基于该背景，我们调研了下比较流行的微服务网关(Kong)。</p>
<h2 id="什么是微服务架构"><a href="#什么是微服务架构" class="headerlink" title="什么是微服务架构"></a>什么是微服务架构</h2><p>微服务是一种构建软件的架构和方法。在微服务中将以前的单体应用被拆分成多个小的组件，并彼此独立。不同于将所有组件内置于一个架构中的传统单体式应用的构建方法，在微服务架构中，所有的部分都是相互独立的(可以使用不同的语言，不同团队来开发不同的服务模块)。通过合作来完成相同的任务。其中的每一个组件或流程都是微服务。总结微服务的特点就是:<code>更小</code>, <code>更快</code>， <code>更强</code>。</p>
<p>可能通过上面对微服务的描述还是不是特别的直观，将传统的单体应用架构和微服务架构进行下比较，就比较直观了。</p>
<p>1.单体应用架构</p>
<p>最早对于web程序的开发(比如JAVA)，通常将整个程序打包到一个WAR文件中，然后直接部署到服务器即可。</p>
<div align="left"><br><img src="http://p8.qhimg.com/t011825c71af9ef6333.png" width="750" height="230" alt="microservices"><br></div>

<p>单体应用架构易于测试和部署，但是在服务的<code>可伸缩性</code>，<code>可靠性</code>， <code>系统迭代</code>， <code>跨语言程序</code>， <code>团队协作</code>等方便没有微服务方便。</p>
<p>2.微服务架构</p>
<p>为了解决单体应用架构的这些诸多弊端(不是说单体应用架构不好，需要根据不同的业务场景选择不同的服务架构)。可以将单体应用架构拆分成多个独立的小的组件。<br>这样就可以每个团队使用自己的技术栈来实现自己的组件，并在系统迭代的时候独立的进行迭代而不影响整个应用的整体使用。</p>
<div align="left"><br><img src="http://p7.qhimg.com/t01e7882af86180a3c2.png" width="450" height="360" alt="microservices"><br></div>

<p>关于微服务的更多信息可以看下面的参考文档。</p>
<h2 id="为什么需要微服务网关"><a href="#为什么需要微服务网关" class="headerlink" title="为什么需要微服务网关"></a>为什么需要微服务网关</h2><p>首先介绍下什么是API网关，API网关可以提供一个单独且统一的API入口用于访问内部一个或多个API服务。API网关常会提供<code>负载均衡</code>，<code>访问频率限制</code>，<code>认证授权</code>，<code>监控</code>，<code>缓存</code>等功能。</p>
<p>通过API网关，可以将内部服务对外部用户隐藏，而暴露给外部用户真实需要的API，并可以对外部访问进行<code>访问频率的限制</code>同时还可以对外部的用户设置<code>认证授权</code>。来保证应用整体的稳定及安全等等。而网关内部的服务则可以根据自己的需求通过相关的协议(REST API, GRPC)进行通信。</p>
<div align="left"><br><img src="http://p6.qhimg.com/t01ed4ef475ebe62394.png" width="450" height="360" alt="microservices"><br></div>


<h2 id="微服务网关-kong-介绍"><a href="#微服务网关-kong-介绍" class="headerlink" title="微服务网关(kong)介绍"></a>微服务网关(kong)介绍</h2><p><code>kong</code>是一款基于<code>nginx_lua</code>模块写的高可用，易扩展的API网关。由于<code>kong</code>是基于nginx的，所以可以水平的扩展多个kong服务实例，通过前置的负载均衡配置把请求均匀地分到各个server,来应对大批量的网络请求。</p>
<p>kong网关组成:</p>
<ul>
<li>Kong server: 基于nginx的服务器，接收外部的api请求。</li>
<li>PostgreSQL: 用来存储操作的数据。</li>
</ul>
<p>并且kong采用插件机制进行功能的定制，插件集在API请求响应循环的生命周期中被执行。插件使用lua编写。</p>
<div align="left"><br><img src="http://p2.qhimg.com/t018bf371c77bb27dad.png" width="550" height="300" alt="microservices"><br></div>

<p>部署kong服务参考官方文档:<a href="https://konghq.com/install/" target="_blank" rel="noopener">https://konghq.com/install/</a></p>
<p>使用kong服务参考官方文档:<a href="https://docs.konghq.com/" target="_blank" rel="noopener">https://docs.konghq.com/</a></p>
<h2 id="微服务网关-kong-如何与容器服务结合使用"><a href="#微服务网关-kong-如何与容器服务结合使用" class="headerlink" title="微服务网关(kong)如何与容器服务结合使用"></a>微服务网关(kong)如何与容器服务结合使用</h2><p>通过一个具体的例子来描述部署到容器上的服务是如何与微服务网关结合使用的。比如我们现在有<code>人脸检测</code>， <code>宠物检测</code>， <code>鉴黄服务</code>等将这个单独的服务组成一个完成的应用实体来对外提供多功能的服务。</p>
<p>1.首先在容器服务平台上部署我的三个服务实例(人脸检测，宠物检测，鉴黄服务)。并为这些服务实例申请vip。</p>
<div align="left"><br><img src="http://p7.qhimg.com/t0132547a533ca3fb56.png" width="550" height="200" alt="microservices"><br></div>

<p>2.服务注册完成之后，管理端将这三个服务注册到微服务网关(kong)，kong会将注册的信息持久化到PostgreSQL数据库。并可以根据不同的业务为各个服务已<code>插件</code>的形式注册<code>认证授权</code>，<code>访问频率限制</code>，<code>CORS</code>等插件。</p>
<div align="left"><br><img src="http://p7.qhimg.com/t01253df381014dba7c.png" width="550" height="400" alt="microservices"><br></div>

<p>3.当服务注册完成之后，用户端可以基于被授权的用户token去访问他们想要使用的服务。</p>
<div align="left"><br><img src="http://p1.qhimg.com/t019e0ed37087a6eed5.png" width="550" height="400" alt="microservices"><br></div>

<p>整体简单的流程就是这样，我只是简单地介绍了下整体的流程。但是每一个部分都需要想要使用的用户自己去深入了解了：）</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://konghq.com/kong-community-edition/" target="_blank" rel="noopener">https://konghq.com/kong-community-edition/</a><br><a href="https://martinfowler.com/articles/microservices.html?spm=a2c4e.11153940.blogcont2764.12.61092766Awrptv" target="_blank" rel="noopener">https://martinfowler.com/articles/microservices.html?spm=a2c4e.11153940.blogcont2764.12.61092766Awrptv</a><br><a href="https://www.infoq.com/articles/microservices-intro?spm=a2c4e.11153940.blogcont2764.11.61092766Awrptv" target="_blank" rel="noopener">https://www.infoq.com/articles/microservices-intro?spm=a2c4e.11153940.blogcont2764.11.61092766Awrptv</a><br><a href="https://www.redhat.com/zh/topics/microservices" target="_blank" rel="noopener">https://www.redhat.com/zh/topics/microservices</a><br><a href="https://www.nginx.com/blog/introduction-to-microservices/" target="_blank" rel="noopener">https://www.nginx.com/blog/introduction-to-microservices/</a><br><a href="https://github.com/Kong/kong">https://github.com/Kong/kong</a><br><a href="https://www.ibm.com/developerworks/cn/cloud/library/cl-microservices-in-action-part-1/index.html" target="_blank" rel="noopener">https://www.ibm.com/developerworks/cn/cloud/library/cl-microservices-in-action-part-1/index.html</a></p>
</div><div class="tags"><a href="/tags/microservices/">microservices</a></div><div class="post-nav"><a class="pre" href="/2018/09/01/gpu/">GPU Container on Kubernetes</a><a class="next" href="/2018/08/18/etcd-back/">Etcd集群备份及容灾恢复</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://github.com/xigang"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/云计算/">云计算</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/存储/">存储</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/微服务/">微服务</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/nvidia-container-runtime/">深入理解 Nvidia-docker2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/05/nvidia-docker2/">Nvidia-Docker2在kubernetes上实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/14/namespace-md/">浅谈 Linux Namespace</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/16/replicaset/">Kube-Controller-manager之Replicaset Controller源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/08/deployment/">Kube-Controller-manager之Deployment Controller源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/01/gpu/">GPU Container on Kubernetes</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/19/kong/">Api-Gateway Kong与容器服务</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/08/18/etcd-back/">Etcd集群备份及容灾恢复</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/07/08/cgroups/">浅谈Cgroups</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/30/lxcfs/">使用Lxcfs对docker容器隔离</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a><ul></ul><a href="http://www.0x7c00.net/" title="31744" target="_blank">31744</a><ul></ul><a href="https://www.opsdev.cn/" title="360opsdev" target="_blank">360opsdev</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>