<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Kube-Controller-manager之Deployment Controller源码解析 | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kube-Controller-manager之Deployment Controller源码解析</h1><a id="logo" href="/.">xigang's home</a><p class="description">Do it right or don't do it at all</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kube-Controller-manager之Deployment Controller源码解析</h1><div class="post-meta">Sep 8, 2018<span> | </span><span class="category"><a href="/categories/kubernetes/">kubernetes</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>kubernetes从<code>1.2</code>版本增加了一个新的资源对象<code>deployment</code>,并且<code>deployment</code>资源对象是使用频率最高的一个资源对象之一。因此很有必要对deployment controller的机制有所了解。</p>
<p>deployment的主要功能：</p>
<ol>
<li>保证指定的pod副本数健康运行。</li>
<li>支持暂停/恢复机制。</li>
<li>支持deployment回滚机制。</li>
<li>弹性伸缩。</li>
<li>滚动升级。</li>
</ol>
<p>上篇文章已经介绍了<a href="https://xigang.github.io/2018/06/04/controller-manager/" target="_blank" rel="noopener">kube-controller-manaer解析之启动流程</a>。这篇文章开始介绍被kube-controller-manager组件控制并管理的Deployment控制器。</p>
<p>注意: kubernetes 1.9.0, commit Id: 925c127ec6b946659ad0fd596fa959be43f0cc05</p>
<h2 id="Deployment-Controller启动的流程"><a href="#Deployment-Controller启动的流程" class="headerlink" title="Deployment Controller启动的流程"></a>Deployment Controller启动的流程</h2><p>下面是<code>Deployment Controller</code>启动流程的时序图，按照这个时序图介绍下Deployment Controller是如何启动的。</p>
<div align="left"><br><img src="http://p3.qhimg.com/t011339cb06de0b94f9.png" width="800" height="360" alt="deployment-controller"><br></div>

<p>kube-controller-manager会在启动的时候把下面的所有被管理的控制器都启动。其中任何一个控制器启动失败，kube-controller-manager则不会正常的启动。</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">func <span class="symbol">NewControllerInitializers</span>() map[string]<span class="symbol">InitFunc</span> &#123;</span><br><span class="line">    controllers := map[string]<span class="symbol">InitFunc</span>&#123;&#125;</span><br><span class="line">	controllers[<span class="string">"endpoint"</span>] = startEndpointController</span><br><span class="line">	controllers[<span class="string">"replicationcontroller"</span>] = startReplicationController</span><br><span class="line">	controllers[<span class="string">"podgc"</span>] = startPodGCController</span><br><span class="line">	controllers[<span class="string">"resourcequota"</span>] = startResourceQuotaController</span><br><span class="line">	controllers[<span class="string">"namespace"</span>] = startNamespaceController</span><br><span class="line">	controllers[<span class="string">"serviceaccount"</span>] = startServiceAccountController</span><br><span class="line">	controllers[<span class="string">"garbagecollector"</span>] = startGarbageCollectorController</span><br><span class="line">	controllers[<span class="string">"daemonset"</span>] = startDaemonSetController</span><br><span class="line">	controllers[<span class="string">"job"</span>] = startJobController</span><br><span class="line">	controllers[<span class="string">"deployment"</span>] = startDeploymentController</span><br><span class="line">	controllers[<span class="string">"replicaset"</span>] = startReplicaSetController</span><br><span class="line">	controllers[<span class="string">"horizontalpodautoscaling"</span>] = startHPAController</span><br><span class="line">	controllers[<span class="string">"disruption"</span>] = startDisruptionController</span><br><span class="line">	controllers[<span class="string">"statefulset"</span>] = startStatefulSetController</span><br><span class="line">	controllers[<span class="string">"cronjob"</span>] = startCronJobController</span><br><span class="line">	controllers[<span class="string">"csrsigning"</span>] = startCSRSigningController</span><br><span class="line">	controllers[<span class="string">"csrapproving"</span>] = startCSRApprovingController</span><br><span class="line">	controllers[<span class="string">"csrcleaner"</span>] = startCSRCleanerController</span><br><span class="line">	controllers[<span class="string">"ttl"</span>] = startTTLController</span><br><span class="line">	controllers[<span class="string">"bootstrapsigner"</span>] = startBootstrapSignerController</span><br><span class="line">	controllers[<span class="string">"tokencleaner"</span>] = startTokenCleanerController</span><br><span class="line">	controllers[<span class="string">"service"</span>] = startServiceController</span><br><span class="line">	controllers[<span class="string">"node"</span>] = startNodeController</span><br><span class="line">	controllers[<span class="string">"route"</span>] = startRouteController</span><br><span class="line">	controllers[<span class="string">"persistentvolume-binder"</span>] = startPersistentVolumeBinderController</span><br><span class="line">	controllers[<span class="string">"attachdetach"</span>] = startAttachDetachController</span><br><span class="line">	controllers[<span class="string">"persistentvolume-expander"</span>] = startVolumeExpandController</span><br><span class="line">	controllers[<span class="string">"clusterrole-aggregation"</span>] = startClusterRoleAggregrationController</span><br><span class="line">	controllers[<span class="string">"pvc-protection"</span>] = startPVCProtectionController</span><br><span class="line"></span><br><span class="line">	return controllers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中就包含我我们这篇文章介绍的<code>Deployment Controlelr</code>控制器：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">controllers[<span class="string">"deployment"</span>] = startDeploymentController</span><br></pre></td></tr></table></figure>
<p>在<code>startDeploymentController</code>方法中调用<code>NewDeploymentController</code>方法对<code>DeploymentController</code>对象进行初始化。</p>
<p>DeploymentController对象定义的结构如下:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">type DeploymentController struct &#123;</span><br><span class="line">	rsControl     controller.RSControlInterface</span><br><span class="line"><span class="built_in">	client </span>       clientset.Interface</span><br><span class="line">	eventRecorder record.EventRecorder</span><br><span class="line">	syncHandler func(dKey string) <span class="builtin-name">error</span>	enqueueDeployment func(deployment <span class="number">*e</span>xtensions.Deployment)</span><br><span class="line">	dLister extensionslisters.DeploymentLister	rsLister extensionslisters.ReplicaSetLister</span><br><span class="line">	podLister corelisters.PodLister	dListerSynced cache.InformerSynced</span><br><span class="line">	rsListerSynced cache.InformerSynced</span><br><span class="line">	podListerSynced cache.InformerSynced</span><br><span class="line"><span class="built_in">	queue </span>workqueue.RateLimitingInterface</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>syncHandler</code>是deployment的核心逻辑，控制器watch到的所有Deployment资源对象都会被放到<code>queue</code>工作队列中。然后在<code>Run</code>的时候启动指定<code>ConcurrentDeploymentSyncs</code>数量的goroutine从<code>queue</code>消费去执行<code>syncHandler</code>部分的核心逻辑。</p>
<p>好了，<code>Deployment Controlelr</code>的启动流程现在没有问题了，下面我们就介绍下<code>Deployment Controller</code>的核心逻辑:<code>syncDeployment</code>。</p>
<h2 id="Deployment-Controller核心逻辑解析"><a href="#Deployment-Controller核心逻辑解析" class="headerlink" title="Deployment Controller核心逻辑解析"></a>Deployment Controller核心逻辑解析</h2><p>下面这张时序图最主要是介绍<code>Deployment Controller</code>的核心的逻辑的一个实现流程。(双击图片放大)</p>
<div align="left"><br><img src="http://p7.qhimg.com/t019e45124eefc59fc1.png" width="1200" height="1500" alt="deployment-controller"><br></div>

<ul>
<li>syncDeployment: deployment控制器的核心逻辑入口。</li>
<li>splitMetaNamespaceKey: 对deployment key(namespace/name 形式)进行切分，获取deployment所在的namespace及deplyment name。</li>
<li>getDeployment: 通过上面<code>splitMetaNamespaceKey</code>获取的<code>namespace</code>和<code>name</code>从本地的cache中获取该Deployment资源对象(注意需要对从cache中获取的deployment进行深度拷贝. deployment.DeepCopy()否则修改的只是cache中的数据)。</li>
<li>getReplicaSetsForDeployment:获取属于该deployment的所有replicaset。<ul>
<li>rsList: 获取deployment namespace下的所有replicaset。</li>
<li>canAdoptFunc: 检查deployment是否被删除。如果在处理过程deployment被删除了，则直接返回，不需要进行下面操作。</li>
<li>NewReplicaSetControllerRefManager: 创建<code>ReplicaSetControllerRefManager</code>对象并暴露出一些方法用于管理属于该Deployment的ReplciaSet.（如对ReplicaSet对象的更新操作等）</li>
<li>ClaimReplicaSets: 对属于该deploymeng的replicaset进行领养。</li>
</ul>
</li>
</ul>
<p><code>ReplicaSetControllerRefManager</code>对象的定义结构如下:<br>        <figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">type ReplicaSetControllerRefManager struct &#123;</span><br><span class="line">	BaseControllerRefManager</span><br><span class="line">	controllerKind schema.GroupVersionKind</span><br><span class="line">	rsControl      RSControlInterface</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in"> type </span>RSControlInterface<span class="built_in"> interface </span>&#123;</span><br><span class="line">	PatchReplicaSet(namespace, name string, data []byte) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>getPodMapForDeployment: 获取该deployment下的所有Pods,并基于该deployment下的replicaset对属于该deployment下的所有Pod进行(group by)分组。</li>
<li>DeletionTimestamp != nil: 判断该Deployment是否已经被删除，如果正在处理的deployment被删除了，则调用<code>syncStatusOnly</code>方法，对deployment的状态进行同步。</li>
</ul>
<p><code>syncStatusOnly</code>方法的定义:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// syncStatusOnly only updates Deployments Status and doesn't take any mutating actions.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dc *DeploymentController)</span> <span class="title">syncStatusOnly</span><span class="params">(d *extensions.Deployment, rsList []*extensions.ReplicaSet, podMap <span class="keyword">map</span>[types.UID]*v1.PodList)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	newRS, oldRSs, err := dc.getAllReplicaSetsAndSyncRevision(d, rsList, podMap, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	allRSs := <span class="built_in">append</span>(oldRSs, newRS)</span><br><span class="line">	<span class="keyword">return</span> dc.syncDeploymentStatus(allRSs, newRS, d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>getAllReplicaSetsAndSyncRevision: 获取该Deployment下的所有的ReplicaSet(包括最新的，和所有老的ReplicaSet)并更新最新的ReplicaSet和Deployment的Revision number。<ul>
<li>rsAndPodsWithHashKeySynced:对该deployment下的所有replicaset和pod增加<code>pod_template_label</code>.增加<code>pod_template_label</code>的作用主要用于<code>ReplicaSet</code>对属于它的Pod进行领养操作。</li>
<li>FindOldReplicaSets: 获取该deployment下的所有的老的replicaset.</li>
<li>getNewReplicaSet: 获取该deployment下的最新的replicaset.</li>
</ul>
</li>
<li>syncDeploymentStatus: 同步deployment的状态信息。</li>
</ul>
<p><code>getAllReplicaSetsAndSyncRevision</code>方法的定义:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">func</span> <span class="params">(dc *DeploymentController)</span> <span class="title">getAllReplicaSetsAndSyncRevision</span><span class="params">(d *extensions.Deployment, rsList []*extensions.ReplicaSet, podMap <span class="keyword">map</span>[types.UID]*v1.PodList, createIfNotExisted <span class="keyword">bool</span>)</span> <span class="params">(*extensions.ReplicaSet, []*extensions.ReplicaSet, error)</span></span> &#123;</span><br><span class="line">	<span class="comment">// List the deployment's RSes &amp; Pods and apply pod-template-hash info to deployment's adopted RSes/Pods</span></span><br><span class="line">	rsList, err := dc.rsAndPodsWithHashKeySynced(d, rsList, podMap)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, fmt.Errorf(<span class="string">"error labeling replica sets and pods with pod-template-hash: %v"</span>, err)</span><br><span class="line">	&#125;</span><br><span class="line">	_, allOldRSs := deploymentutil.FindOldReplicaSets(d, rsList)</span><br><span class="line">	<span class="comment">// Get new replica set with the updated revision number</span></span><br><span class="line">	newRS, err := dc.getNewReplicaSet(d, rsList, allOldRSs, createIfNotExisted)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> newRS, allOldRSs, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>checkPausedConditions: 判断deployment是否pause,如果是则更新该deployment的状态。</li>
<li>paused = true: 如果deployment处于暂停状态，调用<code>sync</code>方法，执行deployment状态的同步。下面的<code>sync</code>中调用的一些方法:<ul>
<li>getAllReplicaSetsAndSyncRevision: 解释同上。</li>
<li>scale: 判断ReplicaSet是否应该扩缩容,如果是则根据deployment的MaxSure和MaxUnaviable进行扩缩容。</li>
<li>cleanupDeployment: 依据deployment的<code>RevisionHistoryLimit</code>参数，对多余的ReplicaSet进行清理。</li>
<li>syncDeploymentStatus: 同步deployment的状态信息。</li>
</ul>
</li>
</ul>
<p><code>sync</code>方法的定义:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dc *DeploymentController)</span> <span class="title">sync</span><span class="params">(d *extensions.Deployment, rsList []*extensions.ReplicaSet, podMap <span class="keyword">map</span>[types.UID]*v1.PodList)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	newRS, oldRSs, err := dc.getAllReplicaSetsAndSyncRevision(d, rsList, podMap, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := dc.scale(d, newRS, oldRSs); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// If we get an error while trying to scale, the deployment will be requeued</span></span><br><span class="line">		<span class="comment">// so we can abort this resync</span></span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Clean up the deployment when it's paused and no rollback is in flight.</span></span><br><span class="line">	<span class="keyword">if</span> d.Spec.Paused &amp;&amp; d.Spec.RollbackTo == <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err := dc.cleanupDeployment(oldRSs, d); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	allRSs := <span class="built_in">append</span>(oldRSs, newRS)</span><br><span class="line">	<span class="keyword">return</span> dc.syncDeploymentStatus(allRSs, newRS, d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>rollbackTo: 判断是否需要对deployment进行回滚。如果是则进行回滚操作。<ul>
<li>getAllReplicaSetsAndSyncRevision:  解释同上。</li>
<li>根据<code>toRevision</code>来决定回滚到具体的哪一个版本。如果没有指定<code>toRevision</code>则回滚到最新的一个ReplicaSet（就是最近的一次ReplicaSet版本）。如果指定了<code>toRevision</code>版本，则回滚到指定的版本就ok了。</li>
</ul>
</li>
<li>isScalingEvent: 判断是不是只是执行规模调整</li>
</ul>
<figure class="highlight hsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">scalingEvent, <span class="keyword">err</span> := dc.isScalingEvent(d, rsList, podMap)</span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> scalingEvent &#123;</span><br><span class="line">		<span class="keyword">return</span> dc.sync(d, rsList, podMap)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<pre><code>isScalingEvent方法的定义:

<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(dc *DeploymentController)</span> <span class="title">isScalingEvent</span><span class="params">(d *extensions.Deployment, rsList []*extensions.ReplicaSet, podMap <span class="keyword">map</span>[types.UID]*v1.PodList)</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">	newRS, oldRSs, err := dc.getAllReplicaSetsAndSyncRevision(d, rsList, podMap, <span class="literal">false</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	allRSs := <span class="built_in">append</span>(oldRSs, newRS)</span><br><span class="line">	<span class="keyword">for</span> _, rs := <span class="keyword">range</span> controller.FilterActiveReplicaSets(allRSs) &#123;</span><br><span class="line">		desired, ok := deploymentutil.GetDesiredReplicasAnnotation(rs)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> desired != *(d.Spec.Replicas) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>, <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

如果是则执行`sync`对Deployment期望的副本数进行scale up/scale down操作。
</code></pre><ul>
<li><p>根据Strategy类型，判断执行的更新操作是直接更新还是滚动更新，并分别执行对应操作Strategy</p>
<ul>
<li><p>如果是Recreate操作，则执行<code>rolloutRecreate</code>方法:</p>
<ul>
<li>getAllReplicaSetsAndSyncRevision: 解释同上。</li>
<li>FilterActiveReplicaSets:获取副本数不为0的ReplicaSets.</li>
<li>scaleDownOldReplicaSetsForRecreate: scale down old replica sets.</li>
<li>scaleUpNewReplicaSetForRecreate: scale up new replica set.</li>
<li>syncRolloutStatus: Sync deployment status.</li>
</ul>
</li>
<li><p>如果是RollingUpdate操作，则指定<code>rolloutRolling</code>方法:</p>
<ul>
<li>getAllReplicaSetsAndSyncRevision: 解释同上。</li>
<li>reconcileNewReplicaSet: 扩容新的ReplicaSet.</li>
<li>reconcileOldReplicaSets: 收容老的ReplicaSet.</li>
<li>syncRolloutStatus: 缩容后设置状态并退出.</li>
<li>cleanupDeployment: 依据deployment的RevisionHistoryLimit参数，对多余的ReplicaSet进行清理。</li>
<li>syncRolloutStatus: Sync deployment status</li>
</ul>
</li>
</ul>
<p><code>rolloutRolling</code>方法定义:</p>
  <figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">// rolloutRolling implements the logic for rolling a new replica set.</span></span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="params">(dc *DeploymentController)</span> <span class="title">rolloutRolling</span><span class="params">(d *extensions.Deployment, rsList []*extensions.ReplicaSet, podMap <span class="keyword">map</span>[types.UID]*v1.PodList)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">		newRS, oldRSs, err := dc.getAllReplicaSetsAndSyncRevision(d, rsList, podMap, <span class="literal">true</span>)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		allRSs := <span class="built_in">append</span>(oldRSs, newRS)</span><br><span class="line">		<span class="comment">// Scale up, if we can.</span></span><br><span class="line">		scaledUp, err := dc.reconcileNewReplicaSet(allRSs, newRS, d)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> scaledUp &#123;</span><br><span class="line">			<span class="comment">// Update DeploymentStatus</span></span><br><span class="line">			<span class="keyword">return</span> dc.syncRolloutStatus(allRSs, newRS, d)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Scale down, if we can.</span></span><br><span class="line">		scaledDown, err := dc.reconcileOldReplicaSets(allRSs, controller.FilterActiveReplicaSets(oldRSs), newRS, d)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> scaledDown &#123;</span><br><span class="line">			<span class="comment">// Update DeploymentStatus</span></span><br><span class="line">			<span class="keyword">return</span> dc.syncRolloutStatus(allRSs, newRS, d)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> deploymentutil.DeploymentComplete(d, &amp;d.Status) &#123;</span><br><span class="line">			<span class="keyword">if</span> err := dc.cleanupDeployment(oldRSs, d); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Sync deployment status</span></span><br><span class="line">		<span class="keyword">return</span> dc.syncRolloutStatus(allRSs, newRS, d)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>通过上面对Deployment控制器的初步分析让我们了解了: Deployment控制器的启动过程。Deployment, ReplicaSet和Pod资源对象之间的关系。Deployment的暂停及恢复机制以及回滚和Deployment的历史版本记录之间的关系，弹性扩缩容，滚动升级。当我们在使用deployment过程中遇到相关的问题，可以进一步针对每一个功能点更进行更深入的分析。</p>
</div><div class="tags"><a href="/tags/kubernetes/">kubernetes</a></div><div class="post-nav"><a class="pre" href="/2018/09/16/replicaset/">Kube-Controller-manager之Replicaset Controller源码解析</a><a class="next" href="/2018/09/01/gpu/">GPU Container on Kubernetes</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '86d1945e3a9358946043',
  clientSecret: '304f48ee3394ae5dab75d19a966506e170d850f6',
  repo: 'xigang.github.io',
  owner: 'xigang',
  admin: ['xigang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://github.com/xigang"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/etcd/">etcd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservices/">microservices</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志监控/">日志监控</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/scheduler/" style="font-size: 15px;">scheduler</a> <a href="/tags/kuernetes/" style="font-size: 15px;">kuernetes</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/kubeflow/" style="font-size: 15px;">kubeflow</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/prometheus/" style="font-size: 15px;">prometheus</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/metrics-servere/">Kubernetes Metrics-Server介绍及源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/gang-scheduler/">适合AI场景的调度器 - Gang-Schedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/30/tensorflow/">Tensorflow结合kubeflow进行分布式训练</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/mxnet/">MXNet结合kubeflow进行分布式训练</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/31/Orphaned-pod/">定位 Orphaned Pod Found - but Volume Paths Are Still Present on Disk 问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/prometheus/">记一次InfoQ采访 <<360容器平台监控实践>></a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/08/kubeflow-intro/">Kubeflow使用Kubernetes进行机器学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/24/kube-dns/">Kubernetes DNS 介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/nvidia-container-runtime/">深入理解 Nvidia-docker2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/05/nvidia-docker2/">Nvidia-Docker2在kubernetes上实践</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a><ul></ul><a href="http://www.0x7c00.net/" title="31744" target="_blank">31744</a><ul></ul><a href="https://www.opsdev.cn/" title="360opsdev" target="_blank">360opsdev</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>