<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>记一次InfoQ采访 &lt;&lt;360容器平台监控实践&gt;&gt; | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">记一次InfoQ采访 &lt;&lt;360容器平台监控实践&gt;&gt;</h1><a id="logo" href="/.">xigang's home</a><p class="description">Do it right or don't do it at all</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">记一次InfoQ采访 &lt;&lt;360容器平台监控实践&gt;&gt;</h1><div class="post-meta">Dec 14, 2018<span> | </span><span class="category"><a href="/categories/日志监控/">日志监控</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>InfoQ记者张婵于10月30日采访整理</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>360 在做容器化平台之前，有一个基于小米开源的 Open-Falcon 进行二次开发的老监控系 (Wonder)，这个系统承揽了公司所有的物理机和虚拟机的监控任务。随着容器技术的普及，以容器的方式在创建应用时，由于 Kubernetes 容器编排系统部署的服务具有弹性扩容的特性，而老的监控系统无法感知这些动态创建的服务，已经不适合容器化的场景，所以 360 团队就搭建了一套可以支持服务发现的新监控系统。</p>
<p>目前 360 一共有 5 个 k8s 线上集群，分布在北京上海和郑州，此外还有一些 GPU 集群。<br>容器平台构建以后带来了以下几个方面的好处：</p>
<ul>
<li>节省资源。传统一台物理机只能部署一个实例，虚拟机能部署几个服务，而使用容器一台机器上能部署几十个服务。</li>
<li>提高效率。1. 缩短流程。老系统要增加机器需要提前申请，而使用 Kubernetes 容器平台只要整个资源池里有充足的资源，不用提交预算就可以直接使用。2. 弹性扩容。在流量高峰期，容器平台可以快速扩容；在流量不多的时段，空闲的资源可以处理其他离线任务，对资源的利用率高。</li>
<li>高可用。容器平台可以保证运行的服务数量总是能达到预期。</li>
<li>减轻运维负担。之前所有的部署上线活动都是运维来做。容器平台上线后，开发人员可以直接在程序完成之后将其制作成镜像，自己就可以进行部署。</li>
</ul>
<p>当然任何事情不可能只有好的一面，容器平台也会带来相应的难度。容器平台对服务的调度具有动态性，这就需要监控系统能动态感知服务实例落在哪里，这是监控工作中的一个难点。</p>
<h3 id="360-容器平台的监控维度"><a href="#360-容器平台的监控维度" class="headerlink" title="360 容器平台的监控维度"></a>360 容器平台的监控维度</h3><p>360 容器平台的监控系统对业务的技术指标进行监控，产品是从三个维度进行设计的：</p>
<ul>
<li>容器: 这是最小的粒度。</li>
<li>Pod: 一个 Pod 里面可以有多个容器。</li>
<li>应用: 一个应用里可能会有多个 Pod。</li>
</ul>
<p>除了这些技术指标监控，360 容器平台的监控系统还支持自定义监控。有些业务可能需要在自己的程序里打点，比如要调第三方接口，查看延时和调用的次数等。大平台上不同业务对数据的需求不同，为了达到业务需求，支持自定义监控还是很必要的。新开发的业务可以在自己的程序里引入 Prometheus 相关的 SDK 进行打点，360 的容器平台就会将这些 metrics 收集上来。</p>
<p>另外，没有使用 Prometheus 的老系统在开发时没有在程序里打点的功能，这时业务可以针对自己的需求以 sidecar 的方式在程序的边缘写 exporter 来采集该进程所有的监控数据，exporter 以 metrics 的形式报告给 Prometheus，Prometheus 进行抓取。</p>
<h3 id="监控系统设计"><a href="#监控系统设计" class="headerlink" title="监控系统设计"></a>监控系统设计</h3><p>360 容器平台监控系统架构图如下：</p>
<div align="left"><br><img src="http://p8.qhimg.com/t015be3df104ceed9bd.png" width="1000" height="520" alt=""><br></div>

<h3 id="日志监控"><a href="#日志监控" class="headerlink" title="日志监控"></a>日志监控</h3><p>360 容器平台监控系统的日志监控使用的是 ELK 技术栈，但是进行了二次开发。团队自己写了 Log controller 组件，该组件会实时地 watch Kubernetes API Server 的 Deployment 资源对象的状态变化。当业务在创建应用时，是以 Kubernetes deployment 的资源对象来创建的。Log controller 会感知到这个资源的创建，知道这个 deployment 下有多少 Pod 已经处于 Ready 状态。当 Log controller 感知到新创建的 Pod 已经处于 Ready 状态以后，会根据用户在创建 Pod 时指定的真实日志收集路径拼接成它在物理机上的绝对路径，然后将组装好的配置并推送到 360 自研的配置中心 QConf 中。</p>
<p>360 在 Kubernetes 集群的每个 Node 节点都会部署一个二次开发的 Logstash，该 Logstash 会定期（每隔十秒或者五秒，时间可配置）去配置中心 (Qconf) 拉取最新的配置。拉取完配置之后，Logstash 会根据最新的配置把相关的的日志收集到公司的 Qbus（对 Kafka 进行包装的产品）中，也就是数据已经进入到 Kafka 了。之后用户可以在 HULK 私有云平台 (内部的私有云平台) 开通 ES 服务，对日志进行检索分析或对其他日志指定数据进行监控。</p>
<div align="left"><br><img src="http://p4.qhimg.com/t01d183ad987ff7df93.png" width="1200" height="460" alt="日志监控系统"><br></div>

<h3 id="数据面板"><a href="#数据面板" class="headerlink" title="数据面板"></a>数据面板</h3><p>360 容器平台监控系统的数据面板使用的是 Grafana，并对其增加了 LDAP 用户认证。可以显示内存，访问量，SIO, GPU 等监控数据指标。</p>
<p>应用级别基础监控指标:</p>
<div align="left"><br><img src="http://p6.qhimg.com/t01053aff2d85b41e24.jpg" width="1000" height="400" alt=""><br></div>

<p>Pod 级别基础监控指标:</p>
<div align="left"><br><img src="http://p7.qhimg.com/t011b3ffbe2fb07ede0.jpg" width="1000" height="400" alt=""><br></div>

<p>容器级别基础监控指标:</p>
<div align="left"><br><img src="http://p3.qhimg.com/t01c85484b51c7bf75a.jpg" width="1000" height="400" alt=""><br></div>

<p>Prometheus 的基本原理是通过 HTTP 协议周期性抓取被监控组件的状态，任意组件只要提供对应的 HTTP 接口就可以接入监控。不需要任何 SDK 或者其他的集成过程。这样做非常适合做虚拟化环境监控系统，比如 VM、Docker、Kubernetes 等。输出被监控组件信息的 HTTP 接口被叫做 exporter 。目前常用的组件大部分都有 exporter 可以直接使用，比如 HAproxy、Nginx、MySQL、Linux 系统信息 (包括磁盘、内存、CPU、网络等等)。</p>
<h3 id="报警"><a href="#报警" class="headerlink" title="报警"></a>报警</h3><p>报警系统使用的是 Prometheus 自带的 Alertmanager 组件，但是对其进行二次开发，集成了 360 自己的报警系统 (Qalram)，并且可以通过 360 自己的即时通信工具（蓝信）实时接收报警信息，友好方便快捷。</p>
<p>Prometheus 的报警基于配置文件形式的。这种情况下，基础性指标可以产品化。360 团队定制了配置模版，用户只需要填具体的监控值就可以了。</p>
<p>针对业务监控，用户需要学习Prometheus的promQL，这是由于不同的业务监控的需求不同，没有办法给业务统一的产品化服务，只能按业务自己制定报警规则去下发报警。</p>
<p>对于自定义业务，让业务自己写告警，统一的配置文件会上报到 QConf。运行在两台 Prometheus 机器上 Agent 会实时的 watch 配置中心 (Qconf) 是否有新的配置生成，如果存在则会 Pull 报警规则，并 reload Prometheus实例。</p>
<h3 id="360-容器平台监控系统选型对比"><a href="#360-容器平台监控系统选型对比" class="headerlink" title="360 容器平台监控系统选型对比"></a>360 容器平台监控系统选型对比</h3><p>在构建容器平台的过程中，360 团队对监控系统的几种常用的开源方案进行过选型对比，主要调研了 K8s 社区的 Heapster（K8s 安装过程中默认安装的插件）和 Prometheus。</p>
<p>Heapster+InlfuxDB+Heapster 自带报警系统的方案有个缺点：它是针对 K8s 容器级别以及 Code 级别的技术指标监控，无法实现业务系统数据的监控，可扩展性不太友好，并且当未来数量级大时，不方便扩容。</p>
<p>最后团队选择了 Prometheus 云原生监控方案。虽然 Prometheus 在持久化方面做的还不够好，但是 Prometheus 更适合云原生生态。因为容器是动态变化的，微服务架构下一个实例的多个副本也是动态变化的，Prometheus 的 Pull 方式更适合动态变化的场景。</p>
<h3 id="Prometheus-的应用实践"><a href="#Prometheus-的应用实践" class="headerlink" title="Prometheus 的应用实践"></a>Prometheus 的应用实践</h3><h5 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h5><div align="left"><br><img src="http://p6.qhimg.com/t0165bc7e39bb04cf8b.png" width="1000" height="600" alt=""><br></div>

<p>现在由于每个机房的机器数量不算太多，当前的设计方式是在每个机房部署一套 Prometheus 实例用于抓取目标的监控数据，同时在每个机房的上一层会部署两套 Prometheus 来做高可用 (HA). 这样上层的 Prometheus 只要去下层抓取关心的 metrics 就可以。这样做的好处:</p>
<p>1.过滤掉上层不关心的监控数据，减轻数据存储的压力。<br>2.对各个机房的数据进行聚合，并统一对外提供统一的报警，视图查询接口。<br>3.由于 promethues 实例运行在本地，本地的磁盘空间有限，默认只保留最近 15 天的监控数据，但是想查询最近一个月，或者半年的数据，这个需求是做不到的。所以将 prometheus 的数据又入到了远程存储 InfluxDB 一份，用于数据的查询使用。</p>
<h3 id="为什么要使用开源系统"><a href="#为什么要使用开源系统" class="headerlink" title="为什么要使用开源系统"></a>为什么要使用开源系统</h3><p>一般公司都有自研的监控系统，大多数监控系统都是基于开源项目开发的。为什么360要使用 Prometheus？</p>
<p>1.在 K8s 大规模使用的今天，整个容器云的生态推荐使用 Prometheus。<br>2.节省人力成本。公司开发一套监控系统需要投入人力，如果后期开发人员流失，后期的维护是个大问题。但是使用开源监控系统，在社区活跃的情况下项目也有保证，并且我们也会在使用过程中回馈社区。</p>
<h3 id="360-容器平台监控系统演进方向"><a href="#360-容器平台监控系统演进方向" class="headerlink" title="360 容器平台监控系统演进方向"></a>360 容器平台监控系统演进方向</h3><p>目前的监控系统整体架构对于容器平台来说可扩展性比较好。未来随着集群规模不断扩大，单个集群只有一个 Prometheus 实例要处理的 Job 数量爆发时，Prometheus 的性能就会变差。这个时候可以针对不同的任务类型，在一个集群里部署多个 Prometheus，每一个 Prometheus 只关心自己的任务，可控性会大大提升，同时整个架构的横向扩展比较方便。</p>
<p>另外 Prometheus 存在持久化的问题，未来还需要对 Prometheus 进行数据远程存储（在上面的架构图中使用的虚线标注部分）。</p>
<p>除了数据，360 也在探索 AIOps，可以对监控系统收集到的数据进行处理，探索故障定位和根因分析等。</p>
<h3 id="普通团队如何构建监控系统？"><a href="#普通团队如何构建监控系统？" class="headerlink" title="普通团队如何构建监控系统？"></a>普通团队如何构建监控系统？</h3><p>360 监控团队认为，公司的监控系统要根据公司的规模和业务场景来定，不可能一套方案直接拿来就直接使用。</p>
<p>对于使用公有云并且规模较小的公司，公有云本身就有监控系统。如果公司自己有服务器，但是量不大，简单搭建一个小型 HA 的监控系统就完全可以满足监控的需求了。架构的演变是随着业务规模的增长而不断的演变改进的。这时就需要根据具体的情况，去选择适合自己平台的架构方案。</p>
<h3 id="作者简介"><a href="#作者简介" class="headerlink" title="作者简介"></a>作者简介</h3><p>王希刚，目前在 360 做运维开发工作, 有着多年 PaaS 设计及开发经验，对 Kubernetes，Docker 等有较深入的研究。目前主要负责 360 HULK 容器云平台的研发工作。</p>
</div><div class="tags"><a href="/tags/prometheus/">prometheus</a></div><div class="post-nav"><a class="pre" href="/2018/12/31/Orphaned-pod/">定位 Orphaned Pod Found - but Volume Paths Are Still Present on Disk 问题</a><a class="next" href="/2018/12/08/kubeflow-intro/">Kubeflow使用Kubernetes进行机器学习</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '86d1945e3a9358946043',
  clientSecret: '304f48ee3394ae5dab75d19a966506e170d850f6',
  repo: 'xigang.github.io',
  owner: 'xigang',
  admin: ['xigang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://github.com/xigang"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/etcd/">etcd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservices/">microservices</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志监控/">日志监控</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/kuernetes/" style="font-size: 15px;">kuernetes</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kubeflow/" style="font-size: 15px;">kubeflow</a> <a href="/tags/prometheus/" style="font-size: 15px;">prometheus</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/12/31/Orphaned-pod/">定位 Orphaned Pod Found - but Volume Paths Are Still Present on Disk 问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/prometheus/">记一次InfoQ采访 <<360容器平台监控实践>></a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/08/kubeflow-intro/">Kubeflow使用Kubernetes进行机器学习</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/24/kube-dns/">Kubernetes DNS 介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/08/nvidia-container-runtime/">深入理解 Nvidia-docker2.0</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/05/nvidia-docker2/">Nvidia-Docker2在kubernetes上实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/10/14/namespace-md/">浅谈 Linux Namespace</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/16/replicaset/">Kube-Controller-manager之Replicaset Controller源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/08/deployment/">Kube-Controller-manager之Deployment Controller源码解析</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/09/01/gpu/">GPU Container on Kubernetes</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a><ul></ul><a href="http://www.0x7c00.net/" title="31744" target="_blank">31744</a><ul></ul><a href="https://www.opsdev.cn/" title="360opsdev" target="_blank">360opsdev</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>