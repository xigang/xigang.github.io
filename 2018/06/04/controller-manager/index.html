<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Kube-Controller-Manaer解析之启动流程 | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kube-Controller-Manaer解析之启动流程</h1><a id="logo" href="/.">xigang's home</a><p class="description">Do it right or don't do it at all</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kube-Controller-Manaer解析之启动流程</h1><div class="post-meta">Jun 4, 2018<span> | </span><span class="category"><a href="/categories/kubernetes/">kubernetes</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><p>最近在工作之余准备看看Kube-controller-manager比较核心的几个控制器，也是现在容器平台主要使用的几个,如:Deployment, ReplicaSet, Garbage Collection, ReousrceQuota， Node Controller等。在分析这些控制器之前，先介绍下kube-controller-manager的功能及它的启动流程。</p>
<p>注意: kubernetes 1.9.0, commit Id: 925c127ec6b946659ad0fd596fa959be43f0cc05</p>
<h3 id="kube-controller-manager-介绍"><a href="#kube-controller-manager-介绍" class="headerlink" title="kube-controller-manager 介绍"></a>kube-controller-manager 介绍</h3><p>controller-manager是 Kubernetes 的大脑，它通过 apiserver 监控整个集群的状态，并确保集群处于预期的工作状态。</p>
<p>kube-controller-manager 有一系列的控制器组成:</p>
<ul>
<li>Replication Controller</li>
<li>Node Controller</li>
<li>CronJob Controller</li>
<li>Daemon Controller</li>
<li>Deployment Controller</li>
<li>Endpoint Controller</li>
<li>Garbage Collector</li>
<li>Job Controller</li>
<li>Pod AutoScaler</li>
<li>ReplicaSet</li>
<li>Service Controller</li>
<li>ServiceAccount Controller</li>
<li>StatefulSet Controller</li>
<li>Volume Controller</li>
<li>Resource quota Controller</li>
</ul>
<p>除了上面的这些控制器，kube-controller-manager还为一些云厂商提供了一些特定的控制器，这里就不介绍了。</p>
<p>kube-controller-manager通过上面的这些资源控制器，来维护集群中各个资源在集群中处于”期望的状态”。本篇文章先介绍下kube-controller-manager的启动流程，之后会陆续的分析一些比较重要的控制器。</p>
<h3 id="kube-controller-manager-启动流程"><a href="#kube-controller-manager-启动流程" class="headerlink" title="kube-controller-manager 启动流程"></a>kube-controller-manager 启动流程</h3><p>kube-controller-manager程序的入口在源码的<code>/kubernetes/cmd/kube-controller-manager</code>位置,内容如下:</p>
<p><div align="left"><br><img src="http://p2.qhimg.com/t013dd41e86f7b09c88.png" width="370" height="400" alt=""></div></p>
<p>除了控制器的入口之外，各个控制器的具体实现主要都在<code>kubernetes/pkg/controller</code>目录下，之后会详细的介绍该目录下各个控制器的实现机制。</p>
<p>下面这张图是kube-controller-manager启动流程的时序图:</p>
<p><div align="left"><br><img src="http://p6.qhimg.com/t01f3a16fc8a0e0a3de.png" width="1000" height="700" alt=""><br>根据上面的这张图，我们来分析下kube-contrller-manager是如何启动的。</div></p>
<ul>
<li>NewCMServer() 主要对CMServer结构进行一些默认参数的初始化工作,并返回CMServer实例对象。</li>
<li>AddFlags()    主要为CMServer实例对象指定flags。</li>
<li>InitFlags()   对AddFlags指定的flags进行命令行参数解析。</li>
<li>InitLogs()    对kube-controller-manager服务进行日志初始化。</li>
<li>Run()         启动kube-controller-manager服务的入口。</li>
</ul>
<p>接下来主要分析下<code>Run()</code>方法,下面是Run方法逻辑的主要流程图:</p>
<p><div align="left"><br><img src="http://p5.qhimg.com/t015fd2c2ed0ef08628.png" width="400" height="500" alt=""></div></p>
<ul>
<li>Validate() 用于controller-manager启动之前对各个控制器进行检验，来检查哪些控制器应该默认开启。</li>
<li>createClients() 用于创建kubeClient, leaderElectionClient及kubeconfig。kubeClient用于跟apiserver进行交互， leaderElectionClient用户多个kube-controller-manager服务实例进行选举，kubeconfig用于之后其它类型client的创建。</li>
<li>startHTTP() 启动http server,默认暴露的端口号:<code>10252</code>。用于controller-manager服务性能检测(如:/debug/profile)及暴露服务相关的metrics供promtheus用于监控。</li>
</ul>
<p><code>LeaderElect</code>用于判断controller-manager实例时单点，还是多点。</p>
<p>如果<code>LeaderElect</code>为<code>false</code>,则说明controller-manager是单点启动的。则直接调用<code>run</code>方法来启动需要被启动的控制器即可。</p>
<p>如果<code>LeaderElect</code>为<code>true</code>,则说明controller-manager是多点启动的，这时多个节点的服务需要进行选举，被选中的服务作为leader来对外提供服务。并回调<code>run</code>方法来启动需要被启动的控制器。</p>
<p>对于启动控制器的<code>run</code>方法，准备在后面介绍，先来介绍下controller-manager的高可用。如果需要部署多个controller-manager需要在每一个实例的配置参数中设置<code>--leader-elect=true</code>启动参数，用于告知controller-manager以HA的方式进行启动。哪个controller-manager想要进行工作，必须先要抢到锁，被选为leader才行。而没有抢到的controller-manager服务只能每隔一段时间进行尝试去获取锁。一旦现有的leader挂掉，就是被剩余的服务抢到锁。来继续提供服务。</p>
<p>分布式锁一般实现原理就是大家先去抢锁，抢到的人成为 leader ，然后 leader 会定期更新锁的状态，声明自己的活动状态，不让其他人把锁抢走。K8s 的资源锁也类似，抢到锁的节点会将自己的标记（目前是hostname）设为锁的持有者，其他人则需要通过对比锁的更新时间和持有者来判断自己是否能成为新的 leader ，而 leader 则可以通过更新 RenewTime 来确保持续保有该锁。</p>
<p>在controller-manager中会创建一个这样的资源锁:</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rl, <span class="built_in">err</span> := resourcelock.<span class="keyword">New</span>(s.LeaderElection.ResourceLock,</span><br><span class="line">		<span class="string">"kube-system"</span>,</span><br><span class="line">		<span class="string">"kube-controller-manager"</span>,</span><br><span class="line">		leaderElectionClient.CoreV1(),</span><br><span class="line">		resourcelock.ResourceLockConfig&#123;</span><br><span class="line">			Identity:      id,</span><br><span class="line">			EventRecorder: recorder,</span><br><span class="line">		&#125;)</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">err</span> != nil &#123;</span><br><span class="line">		glog.Fatalf(<span class="string">"error creating lock: %v"</span>, <span class="built_in">err</span>)</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>之后这个<code>rl</code>资源锁会被用于controller-manager进行leader选举:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">leaderelection</span><span class="selector-class">.RunOrDie</span>(<span class="selector-tag">leaderelection</span><span class="selector-class">.LeaderElectionConfig</span>&#123;</span><br><span class="line">		<span class="attribute">Lock</span>:          rl,</span><br><span class="line">		LeaseDuration: s.LeaderElection.LeaseDuration.Duration,</span><br><span class="line">		RenewDeadline: s.LeaderElection.RenewDeadline.Duration,</span><br><span class="line">		RetryPeriod:   s.LeaderElection.RetryPeriod.Duration,</span><br><span class="line">		Callbacks: leaderelection.LeaderCallbacks&#123;</span><br><span class="line">			OnStartedLeading: run,</span><br><span class="line">			OnStoppedLeading: <span class="built_in">func</span>() &#123;</span><br><span class="line">				glog.<span class="built_in">Fatalf</span>(<span class="string">"leaderelection lost"</span>)</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>
<p><code>RunOrDie的参数是leaderelection.LeaderElectionConfig</code>让我们看下<code>leaderelection.LeaderElectionConfig</code>的结构:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">type LeaderElectionConfig struct &#123;</span><br><span class="line">	<span class="comment">// Lock is the resource that will be used for locking</span></span><br><span class="line">	Lock rl.Interface</span><br><span class="line"></span><br><span class="line">	<span class="comment">// LeaseDuration is the duration that non-leader candidates will</span></span><br><span class="line">	<span class="comment">// wait to force acquire leadership. This is measured against time of</span></span><br><span class="line">	<span class="comment">// last observed ack.</span></span><br><span class="line">	LeaseDuration <span class="selector-tag">time</span>.Duration</span><br><span class="line">	<span class="comment">// RenewDeadline is the duration that the acting master will retry</span></span><br><span class="line">	<span class="comment">// refreshing leadership before giving up.</span></span><br><span class="line">	RenewDeadline <span class="selector-tag">time</span>.Duration</span><br><span class="line">	<span class="comment">// RetryPeriod is the duration the LeaderElector clients should wait</span></span><br><span class="line">	<span class="comment">// between tries of actions.</span></span><br><span class="line">	RetryPeriod <span class="selector-tag">time</span>.Duration</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Callbacks are callbacks that are triggered during certain lifecycle</span></span><br><span class="line">	<span class="comment">// events of the LeaderElector</span></span><br><span class="line">	Callbacks LeaderCallbacks</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">type <span class="type">LeaderCallbacks</span> <span class="class"><span class="keyword">struct</span> </span>&#123;</span><br><span class="line">	<span class="comment">// OnStartedLeading is called when a LeaderElector client starts leading</span></span><br><span class="line">	<span class="type">OnStartedLeading</span> <span class="function"><span class="keyword">func</span><span class="params">(stop &lt;-chan <span class="keyword">struct</span>&#123;&#125;)</span></span></span><br><span class="line">	<span class="comment">// OnStoppedLeading is called when a LeaderElector client stops leading</span></span><br><span class="line">	<span class="type">OnStoppedLeading</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line">	<span class="comment">// OnNewLeader is called when the client observes a leader that is</span></span><br><span class="line">	<span class="comment">// not the previously observed leader. This includes the first observed</span></span><br><span class="line">	<span class="comment">// leader when the client starts.</span></span><br><span class="line">	<span class="type">OnNewLeader</span> <span class="function"><span class="keyword">func</span><span class="params">(identity string)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当controller-manager获取锁成为leader之后,会通过<code>LeaderCallbacks</code>回调结构中的<code>OnStartedLeading</code>调用<code>run</code>方法。当controller-manager不在是leader的时候会通过<code>OnStoppedLeading</code>调用指定的相关方法。</p>
<p>Ok,我们继续分析<code>RunOrDie()</code>方法，具体的定义如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RunOrDie starts a client with the provided config or panics if the config</span></span><br><span class="line"><span class="comment">// fails to validate.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RunOrDie</span><span class="params">(lec LeaderElectionConfig)</span></span> &#123;</span><br><span class="line">	le, err := NewLeaderElector(lec)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="built_in">panic</span>(err)</span><br><span class="line">	&#125;</span><br><span class="line">	le.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>NewLeaderElector() 创建一个LeaderElector实例</li>
<li>Run()     通过LeaderElector实例调用Run进行选举(抢锁)。</li>
</ul>
<p><code>Run()</code> 方法的定义如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run starts the leader election loop</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *LeaderElector)</span> <span class="title">Run</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		runtime.HandleCrash()</span><br><span class="line">		le.config.Callbacks.OnStoppedLeading()</span><br><span class="line">	&#125;()</span><br><span class="line">	le.acquire()</span><br><span class="line">	stop := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="keyword">go</span> le.config.Callbacks.OnStartedLeading(stop)</span><br><span class="line">	le.renew()</span><br><span class="line">	<span class="built_in">close</span>(stop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>acquire() 抢锁操作，阻塞所有的资源。</li>
<li>Callbacks.OnStartedLeading(stop) 当抢到锁之后,执行controller-manager的核心函数<code>run()</code>。</li>
<li>renew() 抢到锁后,需要定期更新,确保自己一直持有该锁。</li>
</ul>
<p>下面主要看下<code>acquire</code>和<code>renew</code>方法, <code>run</code>核心函数最后在介绍。</p>
<p><code>acquire()</code>函数的定义如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// acquire loops calling tryAcquireOrRenew and returns immediately when tryAcquireOrRenew succeeds.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *LeaderElector)</span> <span class="title">acquire</span><span class="params">()</span></span> &#123;</span><br><span class="line">	stop := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	glog.Infof(<span class="string">"attempting to acquire leader lease..."</span>)</span><br><span class="line">	wait.JitterUntil(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		succeeded := le.tryAcquireOrRenew()</span><br><span class="line">		le.maybeReportTransition()</span><br><span class="line">		desc := le.config.Lock.Describe()</span><br><span class="line">		<span class="keyword">if</span> !succeeded &#123;</span><br><span class="line">			glog.V(<span class="number">4</span>).Infof(<span class="string">"failed to acquire lease %v"</span>, desc)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		le.config.Lock.RecordEvent(<span class="string">"became leader"</span>)</span><br><span class="line">		glog.Infof(<span class="string">"successfully acquired lease %v"</span>, desc)</span><br><span class="line">		<span class="built_in">close</span>(stop)</span><br><span class="line">	&#125;, le.config.RetryPeriod, JitterFactor, <span class="literal">true</span>, stop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>wait.JitterUntil</code>来周期性的去调用<code>le.tryAcquireOrRenew</code>方法来获取资源锁，直到获取为止。如果获取不到锁，则会以 RetryPeriod 为间隔不断尝试。如果获取到锁，就会关闭通道，通知 wait.JitterUntil 停止尝试。tryAcquireOrRenew是最核心的方法。在renew函数中也有使用到。</p>
<p><code>renew()</code>函数的定义如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// renew loops calling tryAcquireOrRenew and returns immediately when tryAcquireOrRenew fails.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(le *LeaderElector)</span> <span class="title">renew</span><span class="params">()</span></span> &#123;</span><br><span class="line">	stop := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		err := wait.Poll(le.config.RetryPeriod, le.config.RenewDeadline, <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(<span class="keyword">bool</span>, error)</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> le.tryAcquireOrRenew(), <span class="literal">nil</span></span><br><span class="line">		&#125;)</span><br><span class="line">		le.maybeReportTransition()</span><br><span class="line">		desc := le.config.Lock.Describe()</span><br><span class="line">		<span class="keyword">if</span> err == <span class="literal">nil</span> &#123;</span><br><span class="line">			glog.V(<span class="number">4</span>).Infof(<span class="string">"successfully renewed lease %v"</span>, desc)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		le.config.Lock.RecordEvent(<span class="string">"stopped leading"</span>)</span><br><span class="line">		glog.Infof(<span class="string">"failed to renew lease %v: %v"</span>, desc, err)</span><br><span class="line">		<span class="built_in">close</span>(stop)</span><br><span class="line">	&#125;, <span class="number">0</span>, stop)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>renew</code> 只有在获取锁之后才会调用，它会通过持续更新资源锁的数据，来确保继续持有已获得的锁，保持自己的leader状态。</p>
<p><code>tryAcquireOrRenew()</code>函数的定义如下:</p>
<figure class="highlight roboconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">// tryAcquireOrRenew tries to acquire a leader lease if it is not already acquired,</span><br><span class="line">// else it tries to renew the lease if it has already been acquired. Returns true</span><br><span class="line">// on success else returns false.</span><br><span class="line">func (le *LeaderElector) tryAcquireOrRenew() bool &#123;</span><br><span class="line">	<span class="attribute">now</span> := metav1<span class="variable">.Now</span>()</span><br><span class="line">	leaderElectionRecord := rl<span class="variable">.LeaderElectionRecord</span>&#123;</span><br><span class="line">		HolderIdentity:       le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Identity</span>(),</span><br><span class="line">		LeaseDurationSeconds: int(le<span class="variable">.config</span><span class="variable">.LeaseDuration</span> / time<span class="variable">.Second</span>),</span><br><span class="line">		RenewTime:            now,</span><br><span class="line">		AcquireTime:          now,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 1. obtain or create the ElectionRecord</span><br><span class="line">	oldLeaderElectionRecord, err := le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Get</span>()</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		if !errors<span class="variable">.IsNotFound</span>(err) &#123;</span><br><span class="line">			glog<span class="variable">.Errorf</span>("error retrieving resource lock %v: %v", le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Describe</span>(), err)</span><br><span class="line">			return false</span><br><span class="line">		&#125;</span><br><span class="line">		if err = le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Create</span>(leaderElectionRecord); <span class="attribute">err != nil &#123;</span></span><br><span class="line"><span class="attribute">			glog.Errorf("error initially creating leader election record</span>: %v", err)</span><br><span class="line">			return false</span><br><span class="line">		&#125;</span><br><span class="line">		le<span class="variable">.observedRecord</span> = leaderElectionRecord</span><br><span class="line">		le<span class="variable">.observedTime</span> = time<span class="variable">.Now</span>()</span><br><span class="line">		return true</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 2. Record obtained, check the Identity &amp; Time</span><br><span class="line">	if !reflect<span class="variable">.DeepEqual</span>(le<span class="variable">.observedRecord</span>, *oldLeaderElectionRecord) &#123;</span><br><span class="line">		le<span class="variable">.observedRecord</span> = *oldLeaderElectionRecord</span><br><span class="line">		le<span class="variable">.observedTime</span> = time<span class="variable">.Now</span>()</span><br><span class="line">	&#125;</span><br><span class="line">	if le<span class="variable">.observedTime</span><span class="variable">.Add</span>(le<span class="variable">.config</span><span class="variable">.LeaseDuration</span>)<span class="variable">.After</span>(now<span class="variable">.Time</span>) &amp;&amp;</span><br><span class="line">		oldLeaderElectionRecord<span class="variable">.HolderIdentity</span> != le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Identity</span>() &#123;</span><br><span class="line">		glog<span class="variable">.V</span>(4)<span class="variable">.Infof</span>("lock is held by %v and has not yet expired", oldLeaderElectionRecord<span class="variable">.HolderIdentity</span>)</span><br><span class="line">		return false</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 3. We're going to try to update. The leaderElectionRecord is set to it's default</span><br><span class="line">	// here. Let's correct it before updating.</span><br><span class="line">	if oldLeaderElectionRecord<span class="variable">.HolderIdentity</span> == le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Identity</span>() &#123;</span><br><span class="line">		leaderElectionRecord<span class="variable">.AcquireTime</span> = oldLeaderElectionRecord<span class="variable">.AcquireTime</span></span><br><span class="line">		leaderElectionRecord<span class="variable">.LeaderTransitions</span> = oldLeaderElectionRecord<span class="variable">.LeaderTransitions</span></span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		leaderElectionRecord<span class="variable">.LeaderTransitions</span> = oldLeaderElectionRecord<span class="variable">.LeaderTransitions</span> + 1</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// update the lock itself</span><br><span class="line">	if err = le<span class="variable">.config</span><span class="variable">.Lock</span><span class="variable">.Update</span>(leaderElectionRecord); <span class="attribute">err != nil &#123;</span></span><br><span class="line"><span class="attribute">		glog.Errorf("Failed to update lock</span>: %v", err)</span><br><span class="line">		return false</span><br><span class="line">	&#125;</span><br><span class="line">	le<span class="variable">.observedRecord</span> = leaderElectionRecord</span><br><span class="line">	le<span class="variable">.observedTime</span> = time<span class="variable">.Now</span>()</span><br><span class="line">	return true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的这个函数的主要逻辑：</p>
<ul>
<li>获取ElectionRecord记录<ul>
<li>如果没有则创建一条新的ElectionRecord记录，获取锁，并返回true。</li>
<li>如果记录已经存在，说明该controller-manager是leader,检查身份并更新锁的时间。</li>
</ul>
</li>
<li>更新资源锁对象。</li>
</ul>
<p>当哪一个节点上的controller-manager选举成功之后，就会通过回调函数调用<code>run</code>方法。具体的函数的定义如下:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">run := <span class="function"><span class="keyword">func</span><span class="params">(stop &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">		rootClientBuilder := controller.SimpleControllerClientBuilder&#123;</span><br><span class="line">			ClientConfig: kubeconfig,</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		clientBuilder = rootClientBuilder</span><br><span class="line">	</span><br><span class="line">		ctx, err := CreateControllerContext(s, rootClientBuilder, clientBuilder, stop)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			glog.Fatalf(<span class="string">"error building controller context: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line">		saTokenControllerInitFunc := serviceAccountTokenControllerStarter&#123;rootClientBuilder: rootClientBuilder&#125;.startServiceAccountTokenController</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err := StartControllers(ctx, saTokenControllerInitFunc, NewControllerInitializers()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			glog.Fatalf(<span class="string">"error starting controllers: %v"</span>, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ctx.InformerFactory.Start(ctx.Stop)</span><br><span class="line">		<span class="built_in">close</span>(ctx.InformersStarted)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>CreateControllerContext() 创建一个Context实例用于controller-manager中的各个控制器(如:Client, 可以使用的资源等）</li>
<li>saTokenControllerInitFunc() 必须是第一个启动的控制器，用于给其他的控制器设置访问资源的权限。</li>
<li>StartControllers() 启动所有允许默认启动的控制器</li>
</ul>
<p>controller-manager包含的所有控制器的定义如下：</p>
<figure class="highlight prolog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">func <span class="symbol">NewControllerInitializers</span>() map[string]<span class="symbol">InitFunc</span> &#123;</span><br><span class="line">	controllers := map[string]<span class="symbol">InitFunc</span>&#123;&#125;</span><br><span class="line">	controllers[<span class="string">"endpoint"</span>] = startEndpointController</span><br><span class="line">	controllers[<span class="string">"replicationcontroller"</span>] = startReplicationController</span><br><span class="line">	controllers[<span class="string">"podgc"</span>] = startPodGCController</span><br><span class="line">	controllers[<span class="string">"resourcequota"</span>] = startResourceQuotaController</span><br><span class="line">	controllers[<span class="string">"namespace"</span>] = startNamespaceController</span><br><span class="line">	controllers[<span class="string">"serviceaccount"</span>] = startServiceAccountController</span><br><span class="line">	controllers[<span class="string">"garbagecollector"</span>] = startGarbageCollectorController</span><br><span class="line">	controllers[<span class="string">"daemonset"</span>] = startDaemonSetController</span><br><span class="line">	controllers[<span class="string">"job"</span>] = startJobController</span><br><span class="line">	controllers[<span class="string">"deployment"</span>] = startDeploymentController</span><br><span class="line">	controllers[<span class="string">"replicaset"</span>] = startReplicaSetController</span><br><span class="line">	controllers[<span class="string">"horizontalpodautoscaling"</span>] = startHPAController</span><br><span class="line">	controllers[<span class="string">"disruption"</span>] = startDisruptionController</span><br><span class="line">	controllers[<span class="string">"statefulset"</span>] = startStatefulSetController</span><br><span class="line">	controllers[<span class="string">"cronjob"</span>] = startCronJobController</span><br><span class="line">	controllers[<span class="string">"csrsigning"</span>] = startCSRSigningController</span><br><span class="line">	controllers[<span class="string">"csrapproving"</span>] = startCSRApprovingController</span><br><span class="line">	controllers[<span class="string">"csrcleaner"</span>] = startCSRCleanerController</span><br><span class="line">	controllers[<span class="string">"ttl"</span>] = startTTLController</span><br><span class="line">	controllers[<span class="string">"bootstrapsigner"</span>] = startBootstrapSignerController</span><br><span class="line">	controllers[<span class="string">"tokencleaner"</span>] = startTokenCleanerController</span><br><span class="line">	controllers[<span class="string">"service"</span>] = startServiceController</span><br><span class="line">	controllers[<span class="string">"node"</span>] = startNodeController</span><br><span class="line">	controllers[<span class="string">"route"</span>] = startRouteController</span><br><span class="line">	controllers[<span class="string">"persistentvolume-binder"</span>] = startPersistentVolumeBinderController</span><br><span class="line">	controllers[<span class="string">"attachdetach"</span>] = startAttachDetachController</span><br><span class="line">	controllers[<span class="string">"persistentvolume-expander"</span>] = startVolumeExpandController</span><br><span class="line">	controllers[<span class="string">"clusterrole-aggregation"</span>] = startClusterRoleAggregrationController</span><br><span class="line">	controllers[<span class="string">"pvc-protection"</span>] = startPVCProtectionController</span><br><span class="line"></span><br><span class="line">	return controllers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>StartControllers()</code>函数定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">StartControllers</span><span class="params">(ctx ControllerContext, startSATokenController InitFunc, controllers <span class="keyword">map</span>[<span class="keyword">string</span>]InitFunc)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, err := startSATokenController(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> controllerName, initFn := <span class="keyword">range</span> controllers &#123;</span><br><span class="line">		<span class="keyword">if</span> !ctx.IsControllerEnabled(controllerName) &#123;</span><br><span class="line">			glog.Warningf(<span class="string">"%q is disabled"</span>, controllerName)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		started, err := initFn(ctx)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			glog.Errorf(<span class="string">"Error starting %q"</span>, controllerName)</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> !started &#123;</span><br><span class="line">			glog.Warningf(<span class="string">"Skipping %q"</span>, controllerName)</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		glog.Infof(<span class="string">"Started %q"</span>, controllerName)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>StartControllers()</code>方法将controller-manager默认允许启动的所有控制器启动了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>kube-controller-manager启动的流程主要分为两种情况：</p>
<ul>
<li>一种是以单点的形式进行启动，然后直接调用<code>run</code>方法把默认需要开启的控制器进行启动。</li>
<li>第二种是以多点的形式进行启动，然后多个controller-manager实例进行选举，成为leader的实例通过回调函数调用<code>run</code>方法来把默认需要开启的控制器启动。当leader挂掉之后，会重新进行选举，重新开启控制器。</li>
</ul>
</div><div class="tags"><a href="/tags/kubernetes/">kubernetes</a></div><div class="post-nav"><a class="pre" href="/2018/06/30/lxcfs/">使用Lxcfs对docker容器隔离</a><a class="next" href="/2018/05/19/kubernetes-docker-log/">基于Kubernetes容器云日志采集与处理实践</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '86d1945e3a9358946043',
  clientSecret: '304f48ee3394ae5dab75d19a966506e170d850f6',
  repo: 'xigang.github.io',
  owner: 'xigang',
  admin: ['xigang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://github.com/xigang"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/etcd/">etcd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservices/">microservices</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志监控/">日志监控</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/prometheus/" style="font-size: 15px;">prometheus</a> <a href="/tags/kapacitor/" style="font-size: 15px;">kapacitor</a> <a href="/tags/alertmanager/" style="font-size: 15px;">alertmanager</a> <a href="/tags/bosun/" style="font-size: 15px;">bosun</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/cgroup/" style="font-size: 15px;">cgroup</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/kubeflow/" style="font-size: 15px;">kubeflow</a> <a href="/tags/scheduler/" style="font-size: 15px;">scheduler</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a> <a href="/tags/ipvs/" style="font-size: 15px;">ipvs</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/netfilter/" style="font-size: 15px;">netfilter</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/kubernetes-service/">浅谈Kubernetes Service负载均衡实现机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/01/cgroupv2/">CGROUPS VERSION 2</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/11/bosun/">Prometheus基于bosun框架进行告警</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/09/container-resource-metrics/">A Deep Dive Into Kubernetes Metrics - Container Resource Metrics</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/metrics-servere/">Kubernetes Metrics-Server介绍及源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/gang-scheduler/">适合AI场景的调度器 - Gang-Schedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/30/tensorflow/">Tensorflow结合kubeflow进行分布式训练</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/17/mxnet/">MXNet结合kubeflow进行分布式训练</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/31/Orphaned-pod/">定位 Orphaned Pod Found - but Volume Paths Are Still Present on Disk 问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/14/prometheus/">记一次InfoQ采访 <<360容器平台监控实践>></a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a><ul></ul><a href="http://www.0x7c00.net/" title="31744" target="_blank">31744</a><ul></ul><a href="https://www.opsdev.cn/" title="360opsdev" target="_blank">360opsdev</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>