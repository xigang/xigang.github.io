<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Etcd Cluster on Kubernetes | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Etcd Cluster on Kubernetes</h1><a id="logo" href="/.">xigang's home</a><p class="description">Do it right or don't do it at all</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Etcd Cluster on Kubernetes</h1><div class="post-meta">Oct 11, 2019<span> | </span><span class="category"><a href="/categories/etcd/">etcd</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><a id="more"></a>
<p>在kubernetes上部署etcd集群</p>
<p>好处:</p>
<ol>
<li>高可用，保证始终有期望的etcd实例在运行</li>
<li>灵活,可以动态的调整etcd实例的数量，并且可以平滑的通过更新镜像的方式升级etcd版本</li>
</ol>
<p>缺点:</p>
<ol>
<li>需要ceph存储要稳定，并且IO延迟要尽量的小</li>
<li>对kubernetes集群的网络要求高，需要集群的网络稳定，防止etcd集群抖动，以及集群内各个pod之间互相影响</li>
</ol>
<h3 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h3><ul>
<li>kubernetes (version 1.8+)</li>
<li>CoreDNS</li>
<li>etcd 3.2.13+</li>
<li>ceph RBD(<a href="https://kubernetes.io/docs/concepts/storage/storage-classes/#ceph-rbd" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/storage/storage-classes/#ceph-rbd</a>)</li>
<li>S3</li>
</ul>
<h3 id="Deploy-etcd-operator"><a href="#Deploy-etcd-operator" class="headerlink" title="Deploy etcd operator"></a>Deploy etcd operator</h3><ul>
<li>克隆 etcd-operator repo</li>
</ul>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="keyword">clone</span> <span class="title">https</span>://github.com/coreos/etcd-operator.git</span><br></pre></td></tr></table></figure>
<ul>
<li>设置etcd operator RBAC规则</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sh example/rbac/create_role.sh</span></span><br></pre></td></tr></table></figure>
<ul>
<li>安装 etcd operator</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">create</span> -f example/deployment.yaml</span><br><span class="line"> </span><br><span class="line">检查etcd-<span class="keyword">operator</span>服务是否启动成功:</span><br><span class="line">$ kubectl <span class="keyword">get</span> deployment  etcd-<span class="keyword">operator</span></span><br><span class="line"><span class="keyword">NAME</span>            DESIRED   <span class="keyword">CURRENT</span>   UP-<span class="keyword">TO</span>-<span class="built_in">DATE</span>   AVAILABLE   AGE</span><br><span class="line">etcd-<span class="keyword">operator</span>   <span class="number">1</span>         <span class="number">1</span>         <span class="number">1</span>            <span class="number">1</span>           <span class="number">10</span>d</span><br></pre></td></tr></table></figure>
<ul>
<li>etcd operator会自动的创建一个kubernetes Custom Resource Definition(CRD) - <code>EtcdCluster</code></li>
</ul>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get customresourcedefinitions</span><br><span class="line">NAME                                    KIND</span><br><span class="line">etcdclusters<span class="selector-class">.etcd</span><span class="selector-class">.database</span><span class="selector-class">.coreos</span><span class="selector-class">.com</span>   CustomResourceDefinition<span class="selector-class">.v1beta1</span><span class="selector-class">.apiextensions</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></span><br></pre></td></tr></table></figure>
<h3 id="创建-TLS-etcd集群"><a href="#创建-TLS-etcd集群" class="headerlink" title="创建 TLS etcd集群"></a>创建 TLS etcd集群</h3><p>etcd证书制作参考:</p>
<ul>
<li><a href="https://github.com/coreos/etcd-operator/tree/master/example/tls/certs">https://github.com/coreos/etcd-operator/tree/master/example/tls/certs</a></li>
<li><a href="https://coreos.com/os/docs/latest/generate-self-signed-certificates.html" target="_blank" rel="noopener">https://coreos.com/os/docs/latest/generate-self-signed-certificates.html</a></li>
</ul>
<p>将证书做到kubernetes secret中:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> secret </span>generic etcd-addops-client-tls <span class="attribute">--from-file</span>=etcd-client-ca.crt <span class="attribute">--from-file</span>=etcd-client.crt <span class="attribute">--from-file</span>=etcd-client.key</span><br><span class="line">kubectl create<span class="built_in"> secret </span>generic etcd-addops-peer-tls <span class="attribute">--from-file</span>=peer-ca.crt <span class="attribute">--from-file</span>=peer.crt <span class="attribute">--from-file</span>=peer.key</span><br><span class="line">kubectl create<span class="built_in"> secret </span>generic etcd-addops-server-tls <span class="attribute">--from-file</span>=server-ca.crt <span class="attribute">--from-file</span>=server.crt <span class="attribute">--from-file</span>=server.key</span><br></pre></td></tr></table></figure>
<p>编辑example-etcd-cluster.yaml文件内容如下:</p>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> <span class="string">"etcd.database.coreos.com/v1beta2"</span></span><br><span class="line"><span class="symbol">kind:</span> <span class="string">"EtcdCluster"</span></span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> <span class="string">"example"</span>  <span class="meta">#etcd集群名称</span></span><br><span class="line"><span class="symbol">  annotations:</span></span><br><span class="line">    etcd.database.coreos.com/scope: clusterwide</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  size:</span> <span class="number">3</span>  <span class="meta">#etcd集群实例数量</span></span><br><span class="line"><span class="symbol">  pod:</span></span><br><span class="line"><span class="symbol">    annotations:</span> <span class="meta"># 是否暴露etcd集群监控指标</span></span><br><span class="line">      prometheus.io/scrape: <span class="string">"true"</span></span><br><span class="line">      prometheus.io/port: <span class="string">"2379"</span></span><br><span class="line"><span class="symbol">    persistentVolumeClaimSpec:</span>  <span class="meta">#使用pvc将etcd的数据落盘持久化</span></span><br><span class="line"><span class="symbol">      storageClassName:</span> rbd</span><br><span class="line"><span class="symbol">      accessModes:</span></span><br><span class="line">      - ReadWriteOnce</span><br><span class="line"><span class="symbol">      resources:</span></span><br><span class="line"><span class="symbol">        requests:</span></span><br><span class="line"><span class="symbol">          storage:</span> <span class="number">1</span>Gi</span><br><span class="line"><span class="symbol">  TLS:</span>  <span class="meta">#etcd集群 TLS认证</span></span><br><span class="line"><span class="symbol">    static:</span></span><br><span class="line"><span class="symbol">      member:</span></span><br><span class="line"><span class="symbol">        peerSecret:</span> etcd-addops-peer-tls</span><br><span class="line"><span class="symbol">        serverSecret:</span> etcd-addops-server-tls</span><br><span class="line"><span class="symbol">      operatorSecret:</span> etcd-addops-client-tls</span><br></pre></td></tr></table></figure>
<p>编辑完成之后，创建etcd集群:</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f <span class="built_in">example</span>/<span class="built_in">example</span>-etcd-cluster.yaml</span><br></pre></td></tr></table></figure>
<p>关于更多关于EtcdCluster Spec的定义，可以参考:<br><a href="https://github.com/coreos/etcd-operator/blob/master/doc/user/spec_examples.md">https://github.com/coreos/etcd-operator/blob/master/doc/user/spec_examples.md</a></p>
<p>查看etcd集群pods的运行情况:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pods</span><br><span class="line">example-mn7zg95s8s               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">95</span>m</span><br><span class="line">example-x6grchxhmb               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">99</span>m</span><br><span class="line">example-xx8fskdwd6               <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">0</span>          <span class="number">98</span>m</span><br></pre></td></tr></table></figure>
<p>查看etcd集群pvc的情况:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pvc</span><br><span class="line">NAME                 STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class="line">example-mn7zg95s8s   Bound    pvc<span class="number">-288</span>ae7d2-eb2e<span class="number">-11e9</span><span class="number">-9846</span>-fa163e3101ea   <span class="number">1</span>Gi        RWO            rbd            <span class="number">96</span>m</span><br><span class="line">example-x6grchxhmb   Bound    pvc-a1059994-eb2d<span class="number">-11e9</span><span class="number">-9846</span>-fa163e3101ea   <span class="number">1</span>Gi        RWO            rbd            <span class="number">100</span>m</span><br><span class="line">example-xx8fskdwd6   Bound    pvc-c3c173b0-eb2d<span class="number">-11e9</span><span class="number">-9846</span>-fa163e3101ea   <span class="number">1</span>Gi        RWO            rbd            <span class="number">99</span>m</span><br></pre></td></tr></table></figure>
<p>查看etcd集群pv的情况:</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pv</span><br><span class="line">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                        STORAGECLASS   REASON   AGE</span><br><span class="line">pvc<span class="number">-288</span>ae7d2-eb2e<span class="number">-11e9</span><span class="number">-9846</span>-fa163e3101ea   <span class="number">1</span>Gi        RWO            Delete           Bound    <span class="section">default</span>/example-mn7zg95s8s   rbd                     <span class="number">97</span>m</span><br><span class="line">pvc-a1059994-eb2d<span class="number">-11e9</span><span class="number">-9846</span>-fa163e3101ea   <span class="number">1</span>Gi        RWO            Delete           Bound    <span class="section">default</span>/example-x6grchxhmb   rbd                     <span class="number">100</span>m</span><br><span class="line">pvc-c3c173b0-eb2d<span class="number">-11e9</span><span class="number">-9846</span>-fa163e3101ea   <span class="number">1</span>Gi        RWO            Delete           Bound    <span class="section">default</span>/example-xx8fskdwd6   rbd                     <span class="number">99</span>m</span><br></pre></td></tr></table></figure>
<h3 id="访问etcd集群"><a href="#访问etcd集群" class="headerlink" title="访问etcd集群"></a>访问etcd集群</h3><h4 id="kuberetes集群内部访问etcd集群"><a href="#kuberetes集群内部访问etcd集群" class="headerlink" title="kuberetes集群内部访问etcd集群:"></a>kuberetes集群内部访问etcd集群:</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># docker exec -it <span class="number">9136</span>a005229e <span class="keyword">sh</span></span><br><span class="line">/ # ETCDCTL_API=<span class="number">3</span> etcdctl --cacert=<span class="comment">"/etc/etcdtls/operator/etcd-tls/etcd-client-c</span></span><br><span class="line"><span class="keyword">a</span>.crt<span class="string">" --cert="</span>/etc/etcdtls/operator/etcd-tls/etcd-client.crt<span class="string">" --key="</span>/etc/etcdt</span><br><span class="line"><span class="keyword">ls</span>/operator/etcd-tls/etcd-client.key<span class="string">" --endpoints="</span>http<span class="variable">s:</span>//example-client.defaul</span><br><span class="line">t.svc:<span class="number">2379</span><span class="comment">" member list</span></span><br><span class="line"><span class="number">51</span>c79f48887c71c3, started, example-mn7zg95s8s, http<span class="variable">s:</span>//example-mn7zg95s8s.example.default.svc:<span class="number">2380</span>, http<span class="variable">s:</span>//example-mn7zg95s8s.example.default.svc:<span class="number">2379</span></span><br><span class="line"><span class="number">589</span>b77d81c2e267d, started, example-xx8fskdwd6, http<span class="variable">s:</span>//example-xx8fskdwd6.example.default.svc:<span class="number">2380</span>, http<span class="variable">s:</span>//example-xx8fskdwd6.example.default.svc:<span class="number">2379</span></span><br><span class="line"><span class="number">64</span>f355e75da60cdb, started, example-x6grchxhmb, http<span class="variable">s:</span>//example-x6grchxhmb.example.default.svc:<span class="number">2380</span>, http<span class="variable">s:</span>//example-x6grchxhmb.example.default.svc:<span class="number">2379</span></span><br></pre></td></tr></table></figure>
<h4 id="kubernetes集群外部访问etcd集群"><a href="#kubernetes集群外部访问etcd集群" class="headerlink" title="kubernetes集群外部访问etcd集群:"></a>kubernetes集群外部访问etcd集群:</h4><p>需要将etcd各个实例的ip关联到一个可用的lvs vip下，然后通过vip或者vip关联的域名对运行在kubernetes集群中的etcd集群进行访问:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">/ # ETCDCTL_API=<span class="number">3</span> etcdctl --cacert=<span class="comment">"/etc/etcdtls/operator/etcd-tls/etcd-client-c</span></span><br><span class="line"><span class="keyword">a</span>.crt<span class="string">" --cert="</span>/etc/etcdtls/operator/etcd-tls/etcd-client.crt<span class="string">" --key="</span>/etc/etcdt</span><br><span class="line"><span class="keyword">ls</span>/operator/etcd-tls/etcd-client.key<span class="string">" --endpoints="</span>http<span class="variable">s:</span>//<span class="symbol">&lt;vip&gt;</span>:<span class="number">2379</span><span class="comment">" m</span></span><br><span class="line">ember <span class="keyword">list</span></span><br><span class="line"><span class="number">51</span>c79f48887c71c3, started, example-mn7zg95s8s, http<span class="variable">s:</span>//example-mn7zg95s8s.example.default.svc:<span class="number">2380</span>, http<span class="variable">s:</span>//example-mn7zg95s8s.example.default.svc:<span class="number">2379</span></span><br><span class="line"><span class="number">589</span>b77d81c2e267d, started, example-xx8fskdwd6, http<span class="variable">s:</span>//example-xx8fskdwd6.example.default.svc:<span class="number">2380</span>, http<span class="variable">s:</span>//example-xx8fskdwd6.example.default.svc:<span class="number">2379</span></span><br><span class="line"><span class="number">64</span>f355e75da60cdb, started, example-x6grchxhmb, http<span class="variable">s:</span>//example-x6grchxhmb.example.default.svc:<span class="number">2380</span>, http<span class="variable">s:</span>//example-x6grchxhmb.example.default.svc:<span class="number">2379</span></span><br><span class="line">/ #</span><br></pre></td></tr></table></figure>
<h3 id="etcd集群数据备份及恢复"><a href="#etcd集群数据备份及恢复" class="headerlink" title="etcd集群数据备份及恢复"></a>etcd集群数据备份及恢复</h3><h4 id="etcd集群数据备份"><a href="#etcd集群数据备份" class="headerlink" title="etcd集群数据备份"></a>etcd集群数据备份</h4><p>部署etcd-backup-operator:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">create</span> -f example/etcd-<span class="keyword">backup</span>-<span class="keyword">operator</span>/deployment.yaml</span><br><span class="line">$ kubectl <span class="keyword">get</span> pods</span><br><span class="line"><span class="keyword">NAME</span>                                    READY   <span class="keyword">STATUS</span>    RESTARTS   AGE</span><br><span class="line">etcd-<span class="keyword">backup</span>-<span class="keyword">operator</span><span class="number">-68</span>f847c4d9-k6pnj   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">1</span>          <span class="number">6</span>h11m</span><br></pre></td></tr></table></figure>
<p>检查etcd-backup-operator是否创建EtcdBackup CRD成功:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get crd</span><br><span class="line">NAME                                    KIND</span><br><span class="line">etcdbackups<span class="selector-class">.etcd</span><span class="selector-class">.database</span><span class="selector-class">.coreos</span><span class="selector-class">.com</span>    CustomResourceDefinition<span class="selector-class">.v1beta1</span><span class="selector-class">.apiextensions</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></span><br></pre></td></tr></table></figure>
<p>配置AWS secret（这里将数据上传到S3上）</p>
<ul>
<li>在本地创建credentials和config文件（注意文件名称必须是:credentials和config）</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="variable">$AWS_DIR</span>/credentials</span><br><span class="line">[default]</span><br><span class="line">aws_access_key_id = XXX</span><br><span class="line">aws_secret_access_key = XXX</span><br><span class="line"> </span><br><span class="line">$ cat <span class="variable">$AWS_DIR</span>/config</span><br><span class="line">[default]</span><br><span class="line">region = &lt;region&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 aws secret:</li>
</ul>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create<span class="built_in"> secret </span>generic aws <span class="attribute">--from-file</span>=<span class="variable">$AWS_DIR</span>/credentials <span class="attribute">--from-file</span>=<span class="variable">$AWS_DIR</span>/config</span><br></pre></td></tr></table></figure>
<ul>
<li>创建EtcdBackup CR， 编辑periodic_backup_cr.yaml如下:</li>
</ul>
<figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">apiVersion:</span> <span class="string">"etcd.database.coreos.com/v1beta2"</span></span><br><span class="line"><span class="symbol">kind:</span> <span class="string">"EtcdBackup"</span></span><br><span class="line"><span class="symbol">metadata:</span></span><br><span class="line"><span class="symbol">  name:</span> example-etcd-cluster-periodic-backup</span><br><span class="line"><span class="symbol">spec:</span></span><br><span class="line"><span class="symbol">  etcdEndpoints:</span> [<span class="string">"https://example-client.default.svc:2379"</span>]</span><br><span class="line"><span class="symbol">  clientTLSSecret:</span> etcd-addops-client-tls</span><br><span class="line"><span class="symbol">  storageType:</span> S3</span><br><span class="line"><span class="symbol">  backupPolicy:</span></span><br><span class="line">    <span class="meta"># 0 &gt; enable periodic backup</span></span><br><span class="line"><span class="symbol">    backupIntervalInSecond:</span> <span class="number">125</span></span><br><span class="line"><span class="symbol">    maxBackups:</span> <span class="number">4</span></span><br><span class="line"><span class="symbol">  s3:</span></span><br><span class="line">    <span class="meta"># The format of <span class="string">"path"</span> must be: <span class="string">"&lt;s3-bucket-name&gt;/&lt;path-to-backup-file&gt;"</span></span></span><br><span class="line">    <span class="meta"># e.g: <span class="string">"mybucket/etcd.backup"</span></span></span><br><span class="line"><span class="symbol">    path:</span> etcd-bucket/etcd.backup</span><br><span class="line"><span class="symbol">    awsSecret:</span> aws</span><br><span class="line"><span class="symbol">    endpoint:</span> http:<span class="comment">//xx.xxx.xx.cn</span></span><br><span class="line"><span class="symbol">    forcePathStyle:</span> true</span><br></pre></td></tr></table></figure>
<ul>
<li>检查etcd需要备份的数据是否，已经备注到了S3上:</li>
</ul>
<div align="left"><br><img src="http://p4.qhimg.com/t0149e5fef75db24683.png" width="800" height="160" alt="etcd-operator"><br></div>


<h4 id="etcd集群数据恢复"><a href="#etcd集群数据恢复" class="headerlink" title="etcd集群数据恢复"></a>etcd集群数据恢复</h4><p>etcd-restore-operator会使用backup数据将运行在kubernetes上的etcd集群恢复,恢复的处理流程是：需要将已经存在的etcd集群删除掉，然后在使用backup数据创建一个新的etcd集群，作为恢复的etcd集群。</p>
<p>部署etcd-restore-operator</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl <span class="keyword">create</span> -f example/etcd-<span class="keyword">restore</span>-<span class="keyword">operator</span>/deployment.yaml</span><br></pre></td></tr></table></figure>
<p>检查etcd-restore-operator pod是否创建成功</p>
<figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># kubectl get pods</span><br><span class="line">NAME                                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">etcd-restore-operator<span class="number">-859</span>c9f479-lkzsm   <span class="number">1</span>/<span class="number">1</span>     Running   <span class="number">2</span>          <span class="number">49</span>m</span><br></pre></td></tr></table></figure>
<p>检查etcd-restore-operator是否创建EtcdRestore CRD成功</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get crd</span><br><span class="line">NAME                                       KIND</span><br><span class="line">etcdrestores<span class="selector-class">.etcd</span><span class="selector-class">.database</span><span class="selector-class">.coreos</span><span class="selector-class">.com</span>      CustomResourceDefinition<span class="selector-class">.v1beta1</span><span class="selector-class">.apiextensions</span><span class="selector-class">.k8s</span><span class="selector-class">.io</span></span><br></pre></td></tr></table></figure>
<p>创建EtcdRestore CR,编辑restore_cr.yaml文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">"etcd.database.coreos.com/v1beta2"</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">"EtcdRestore"</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># The restore CR name must be the same as spec.etcdCluster.name</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  etcdCluster:</span></span><br><span class="line">    <span class="comment"># The namespace is the same as this EtcdRestore CR</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">example</span></span><br><span class="line"><span class="attr">  backupStorageType:</span> <span class="string">S3</span></span><br><span class="line"><span class="attr">  s3:</span></span><br><span class="line">    <span class="comment"># The format of "path" must be: "&lt;s3-bucket-name&gt;/&lt;path-to-backup-file&gt;"</span></span><br><span class="line">    <span class="comment"># e.g: "mybucket/etcd.backup"</span></span><br><span class="line"><span class="attr">    path:</span> <span class="string">etcd-bucket/etcd.backup_v2_2019-10-11-08:53:40</span></span><br><span class="line"><span class="attr">    awsSecret:</span> <span class="string">aws</span></span><br><span class="line"><span class="attr">    endpoint:</span> <span class="attr">http://xx.xx.xx.cn</span></span><br><span class="line"><span class="attr">    forcePathStyle:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://github.com/coreos/etcd-operator">https://github.com/coreos/etcd-operator</a></li>
</ul>
</div><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/etcd/">etcd</a></div><div class="post-nav"><a class="next" href="/2019/09/21/client-go/">Kubernetes Client-Go Informer 实现源码剖析</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '86d1945e3a9358946043',
  clientSecret: '304f48ee3394ae5dab75d19a966506e170d850f6',
  repo: 'xigang.github.io',
  owner: 'xigang',
  admin: ['xigang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://github.com/xigang"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/etcd/">etcd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservices/">microservices</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/日志监控/">日志监控</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/coredns/" style="font-size: 15px;">coredns</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/cgroup/" style="font-size: 15px;">cgroup</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/prometheus/" style="font-size: 15px;">prometheus</a> <a href="/tags/kapacitor/" style="font-size: 15px;">kapacitor</a> <a href="/tags/alertmanager/" style="font-size: 15px;">alertmanager</a> <a href="/tags/bosun/" style="font-size: 15px;">bosun</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/dns/" style="font-size: 15px;">dns</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/kube-dns/" style="font-size: 15px;">kube-dns</a> <a href="/tags/kubeflow/" style="font-size: 15px;">kubeflow</a> <a href="/tags/scheduler/" style="font-size: 15px;">scheduler</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a> <a href="/tags/ipvs/" style="font-size: 15px;">ipvs</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/netfilter/" style="font-size: 15px;">netfilter</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/10/11/etcd-cluster-on-kubernetes/">Etcd Cluster on Kubernetes</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/21/client-go/">Kubernetes Client-Go Informer 实现源码剖析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/25/coredns/">CoreDNS源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/22/dns/">A DNS Refresher</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/28/kube-proxy-source-code/">Kube-Proxy  IPVS模式源码分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/kubernetes-service/">浅谈Kubernetes Service负载均衡实现机制</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/01/cgroupv2/">CGROUPS VERSION 2</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/11/bosun/">Prometheus基于bosun框架进行告警</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/09/container-resource-metrics/">A Deep Dive Into Kubernetes Metrics - Container Resource Metrics</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/metrics-servere/">Kubernetes Metrics-Server介绍及源码分析</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>