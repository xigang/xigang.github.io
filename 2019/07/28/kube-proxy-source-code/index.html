<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Kube-Proxy  IPVSæ¨¡å¼æºç åˆ†æ | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kube-Proxy  IPVSæ¨¡å¼æºç åˆ†æ</h1><a id="logo" href="/.">xigang's home</a><p class="description">Do it right or don't do it at all</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Kube-Proxy  IPVSæ¨¡å¼æºç åˆ†æ</h1><div class="post-meta">Jul 28, 2019<span> | </span><span class="category"><a href="/categories/kubernetes/">kubernetes</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span></div><div class="post-content"><p>kube-proxyå½“å‰æ”¯æŒä¸‰ç§æ–¹å¼å®ç°è´Ÿè½½å‡è¡¡ï¼Œåˆ†åˆ«æ˜¯: userspace, Iptables, IPVS. ä½†å‰ä¸¤è€…éšç€Serviceçš„æ•°é‡å¢é•¿ï¼Œå­˜åœ¨æ€§èƒ½çš„ç“¶é¢ˆï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒæ˜¯ä¸èƒ½æ¥å—çš„ã€‚æ‰€ä»¥æœ¬ç¯‡æ–‡ç« ä¸»è¦å¯¹IPVSæ¨¡å¼è¿›è¡Œæºç åˆ†æã€‚</p>
<p>ä»£ç ç‰ˆæœ¬: release-1.15</p>
<a id="more"></a>
<h3 id="kube-proxy-æ•´ä½“é€»è¾‘ç»“æ„"><a href="#kube-proxy-æ•´ä½“é€»è¾‘ç»“æ„" class="headerlink" title="kube-proxy æ•´ä½“é€»è¾‘ç»“æ„"></a>kube-proxy æ•´ä½“é€»è¾‘ç»“æ„</h3><div align="left"><br><img src="http://p4.qhimg.com/t01145ecd4b17bae621.png" width="1000" height="700" alt="kube-proxy"><br></div>

<p>è¿™å¼ æ—¶åºå›¾æè¿°äº†kube-proxyçš„æ•´ä½“é€»è¾‘ç»“æ„ï¼Œç”±äºkub-proxyç»„ä»¶å’Œå…¶å®ƒçš„<code>kube-*</code> ç»„ä»¶ä¸€æ ·éƒ½æ˜¯ä½¿ç”¨<a href="https://github.com/spf13/pflag">pflag</a>å’Œ<a href="https://github.com/spf13/cobra">cobra</a>åº“å»æ„å»ºå‘½ä»¤è¡Œåº”ç”¨ç¨‹åºã€‚æ‰€ä»¥å…ˆç®€å•ä»‹ç»ä¸‹è¯¥åŒ…çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">main</span>() &#123;</span><br><span class="line">  <span class="attribute">command </span>:= &amp;cobra.Command&#123;</span><br><span class="line">    Use:   <span class="string">"echo [string to echo]"</span>,</span><br><span class="line">    Short: <span class="string">"Echo anything to the screen"</span>,</span><br><span class="line">    Long: `echo is for echoing anything back.Echo works a lot like print, except it has a child command.`,</span><br><span class="line">    Args: cobra.<span class="built_in">MinimumNArgs</span>(1),</span><br><span class="line">    Run: <span class="built_in">func</span>(cmd *cobra.Command, args []string) &#123;</span><br><span class="line">      fmt.<span class="built_in">Println</span>(<span class="string">"Print: "</span> + strings.Join(args, <span class="string">" "</span>))</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">command</span><span class="selector-class">.Execute</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ®µä»£ç å°±æ˜¯ä½¿ç”¨<code>cobra</code>åŒ…çš„ä¸€ä¸ªæœ€ç®€å•çš„ä¾‹å­ï¼Œé¦–å…ˆåˆå§‹åŒ–Commandç»“æ„ï¼Œå…¶ä¸­è¯¥ç»“æ„ä¸­çš„<code>Run</code>å°±æ˜¯æœ€ç»ˆè¦æ‰§è¡Œçš„çœŸæ­£é€»è¾‘ã€‚å½“åˆå§‹åŒ–å®ŒæˆCommandä¹‹åï¼Œé€šè¿‡<code>commnad.Execute</code>å»å¯åŠ¨åº”ç”¨ç¨‹åºã€‚</p>
<p>ç°åœ¨çœ‹ä¸Šé¢çš„å›¾å°±èƒ½æ¯”è¾ƒç›´è§‚çš„ç†è§£ç¨‹åºçš„å¯åŠ¨æœºåˆ¶äº†ï¼Œè¿™å¼ å›¾çš„æ•´ä½“è¿‡ç¨‹å°±æ˜¯å¯¹Commnadç»“æ„ä¸­çš„<code>Run</code>è¿›è¡Œæ ¸å¿ƒé€»è¾‘å®ç°ã€‚ä¹Ÿå°±æ˜¯è¯´<code>kube-proxyæ ¸å¿ƒé€»è¾‘å…¥å£å°±æ˜¯ä»è¿™é‡Œå¼€å§‹(Command.Run)</code>ã€‚ğŸ˜‹</p>
<p>åœ¨<code>Command.Run</code>ä¸­ä¸»è¦åšäº†å¦‚ä¸‹å‡ ä»¶äº‹,çœ‹ä¸‹é¢çš„ä»£ç :</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Run runs the specified ProxyServer.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(o *Options)</span> <span class="title">Run</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">defer</span> <span class="built_in">close</span>(o.errCh)</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//....</span></span><br><span class="line">	proxyServer, err := NewProxyServer(o)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> o.CleanupAndExit &#123;</span><br><span class="line">		<span class="keyword">return</span> proxyServer.CleanupAndExit()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	o.proxyServer = proxyServer</span><br><span class="line">	<span class="keyword">return</span> o.runLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1.å¯¹<code>ProxyServer</code>å®ä¾‹è¿›è¡Œåˆå§‹åŒ–ã€‚<br>2.å¦‚æœåœ¨å¯åŠ¨kube-proxyæœåŠ¡æ—¶ï¼Œ<code>CleanupAndExit</code>å‚æ•°è®¾ç½®ä¸º<code>true</code>,åˆ™ä¼šå°†<code>userspace</code>, <code>iptables</code>, <code>ipvs</code>ä¸‰ç§æ¨¡å¼ä¹‹å‰è®¾ç½®çš„æ‰€æœ‰è§„åˆ™æ¸…é™¤æ‰ï¼Œç„¶åç›´æ¥é€€å‡ºã€‚<br>3.å¦‚æœåœ¨å¯åŠ¨kube-proxyæœåŠ¡æ—¶ï¼Œ<code>CleanupAndExit</code>å‚æ•°è®¾ç½®ä¸º<code>flase</code>,åˆ™ä¼šè°ƒç”¨<code>runLoop</code>æ¥å¯åŠ¨<code>ProxyServer</code>æœåŠ¡ã€‚</p>
<p>é¦–å…ˆå…ˆæ¥çœ‹çœ‹<code>ProxyServer</code>çš„ç»“æ„å®šä¹‰:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">ProxyServer</span> struct &#123;</span><br><span class="line">	<span class="type">Client</span>                 clientset.<span class="type">Interface</span> </span><br><span class="line">	<span class="type">EventClient</span>            v1core.<span class="type">EventsGetter</span></span><br><span class="line">	<span class="type">IptInterface</span>           utiliptables.<span class="type">Interface</span></span><br><span class="line">	<span class="type">IpvsInterface</span>          utilipvs.<span class="type">Interface</span></span><br><span class="line">	<span class="type">IpsetInterface</span>         utilipset.<span class="type">Interface</span></span><br><span class="line">	execer                 exec.<span class="type">Interface</span></span><br><span class="line">	<span class="type">Proxier</span>                proxy.<span class="type">ProxyProvider</span></span><br><span class="line">	<span class="type">Broadcaster</span>            record.<span class="type">EventBroadcaster</span></span><br><span class="line">	<span class="type">Recorder</span>               record.<span class="type">EventRecorder</span></span><br><span class="line">	<span class="type">ConntrackConfiguration</span> kubeproxyconfig.<span class="type">KubeProxyConntrackConfiguration</span></span><br><span class="line">	<span class="type">Conntracker</span>            <span class="type">Conntracker</span> // if nil, ignored</span><br><span class="line">	<span class="type">ProxyMode</span>              string</span><br><span class="line">	<span class="type">NodeRef</span>                *v1.<span class="type">ObjectReference</span></span><br><span class="line">	<span class="type">CleanupIPVS</span>            bool</span><br><span class="line">	<span class="type">MetricsBindAddress</span>     string</span><br><span class="line">	<span class="type">EnableProfiling</span>        bool</span><br><span class="line">	<span class="type">OOMScoreAdj</span>            *int32</span><br><span class="line">	<span class="type">ConfigSyncPeriod</span>       time.<span class="type">Duration</span></span><br><span class="line">	<span class="type">HealthzServer</span>          *healthcheck.<span class="type">HealthzServer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>ProxyServer</code>ç»“æ„ä¸­:</p>
<p>åŒ…å«äº†ä¸<code>kube-apiserver</code>é€šä¿¡çš„<code>Client</code>ã€‚</p>
<p>æ“ä½œ<code>Iptables</code>çš„<code>IptInterface</code>:</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">type Interface interface &#123;</span><br><span class="line">	<span class="comment">// GetVersion returns the "X.Y.Z" version string for iptables.</span></span><br><span class="line">	GetVersion() (string, error)</span><br><span class="line">	<span class="comment">// EnsureChain checks if the specified chain exists and, if not, creates it.  If the chain existed, return true.</span></span><br><span class="line">	EnsureChain(<span class="keyword">table</span> <span class="keyword">Table</span>, chain <span class="comment">Chain) (bool, error)</span></span><br><span class="line">	<span class="comment">// FlushChain clears the specified chain.  If the chain did not exist, return error.</span></span><br><span class="line">	FlushChain(<span class="keyword">table</span> <span class="keyword">Table</span>, chain <span class="comment">Chain) error</span></span><br><span class="line">	<span class="comment">// DeleteChain deletes the specified chain.  If the chain did not exist, return error.</span></span><br><span class="line">	DeleteChain(<span class="keyword">table</span> <span class="keyword">Table</span>, chain <span class="comment">Chain) error</span></span><br><span class="line">	<span class="comment">// EnsureRule checks if the specified rule is present and, if not, creates it.  If the rule existed, return true.</span></span><br><span class="line">	EnsureRule(position RulePosition, <span class="keyword">table</span> <span class="keyword">Table</span>, chain <span class="comment">Chain, args ...string) (bool, error)</span></span><br><span class="line">	<span class="comment">// DeleteRule checks if the specified rule is present and, if so, deletes it.</span></span><br><span class="line">	DeleteRule(<span class="keyword">table</span> <span class="keyword">Table</span>, chain <span class="comment">Chain, args ...string) error</span></span><br><span class="line">	<span class="comment">// IsIpv6 returns true if this is managing ipv6 tables</span></span><br><span class="line">	IsIpv6() bool</span><br><span class="line">	<span class="comment">// SaveInto calls `iptables-save` for table and stores result in a given buffer.</span></span><br><span class="line">	SaveInto(<span class="keyword">table</span> <span class="keyword">Table</span>, buffer <span class="comment">*bytes.Buffer) error</span></span><br><span class="line">	<span class="comment">// Restore runs `iptables-restore` passing data through []byte.</span></span><br><span class="line">	<span class="comment">// table is the Table to restore</span></span><br><span class="line">	<span class="comment">// data should be formatted like the output of SaveInto()</span></span><br><span class="line">	<span class="comment">// flush sets the presence of the "--noflush" flag. see: FlushFlag</span></span><br><span class="line">	<span class="comment">// counters sets the "--counters" flag. see: RestoreCountersFlag</span></span><br><span class="line">	Restore(<span class="keyword">table</span> <span class="keyword">Table</span>, data <span class="comment">[]byte, flush FlushFlag, counters RestoreCountersFlag) error</span></span><br><span class="line">	<span class="comment">// RestoreAll is the same as Restore except that no table is specified.</span></span><br><span class="line">	RestoreAll(data []byte, flush FlushFlag, counters RestoreCountersFlag) error</span><br><span class="line">	<span class="comment">// AddReloadFunc adds a function to call on iptables reload</span></span><br><span class="line">	AddReloadFunc(reloadFunc func())</span><br><span class="line">	<span class="comment">// Destroy cleans up resources used by the Interface</span></span><br><span class="line">	Destroy()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ“ä½œ<code>IPVS</code>çš„<code>IpvsInterface</code>:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">Interface</span> interface &#123;</span><br><span class="line">	// <span class="type">Flush</span> clears all virtual servers in system. return occurred error immediately.</span><br><span class="line">	<span class="type">Flush</span>() error</span><br><span class="line">	// <span class="type">AddVirtualServer</span> creates the specified virtual server.</span><br><span class="line">	<span class="type">AddVirtualServer</span>(*<span class="type">VirtualServer</span>) error</span><br><span class="line">	// <span class="type">UpdateVirtualServer</span> updates an already existing virtual server.  <span class="type">If</span> the virtual server does not exist, return error.</span><br><span class="line">	<span class="type">UpdateVirtualServer</span>(*<span class="type">VirtualServer</span>) error</span><br><span class="line">	// <span class="type">DeleteVirtualServer</span> deletes the specified virtual server.  <span class="type">If</span> the virtual server does not exist, return error.</span><br><span class="line">	<span class="type">DeleteVirtualServer</span>(*<span class="type">VirtualServer</span>) error</span><br><span class="line">	// <span class="type">Given</span> a partial virtual server, <span class="type">GetVirtualServer</span> will return the specified virtual server information in the system.</span><br><span class="line">	<span class="type">GetVirtualServer</span>(*<span class="type">VirtualServer</span>) (*<span class="type">VirtualServer</span>, error)</span><br><span class="line">	// <span class="type">GetVirtualServers</span> lists all virtual servers in the system.</span><br><span class="line">	<span class="type">GetVirtualServers</span>() ([]*<span class="type">VirtualServer</span>, error)</span><br><span class="line">	// <span class="type">AddRealServer</span> creates the specified real server for the specified virtual server.</span><br><span class="line">	<span class="type">AddRealServer</span>(*<span class="type">VirtualServer</span>, *<span class="type">RealServer</span>) error</span><br><span class="line">	// <span class="type">GetRealServers</span> returns all real servers for the specified virtual server.</span><br><span class="line">	<span class="type">GetRealServers</span>(*<span class="type">VirtualServer</span>) ([]*<span class="type">RealServer</span>, error)</span><br><span class="line">	// <span class="type">DeleteRealServer</span> deletes the specified real server from the specified virtual server.</span><br><span class="line">	<span class="type">DeleteRealServer</span>(*<span class="type">VirtualServer</span>, *<span class="type">RealServer</span>) error</span><br><span class="line">	// <span class="type">UpdateRealServer</span> updates the specified real server from the specified virtual server.</span><br><span class="line">	<span class="type">UpdateRealServer</span>(*<span class="type">VirtualServer</span>, *<span class="type">RealServer</span>) error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ“ä½œ<code>IpSet</code>çš„<code>IpsetInterface</code>:</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Interface is an injectable interface for running ipset commands.  Implementations must be goroutine-safe.</span></span><br><span class="line"><span class="built_in">type</span> Interface interface &#123;</span><br><span class="line">	<span class="comment">// FlushSet deletes all entries from a named set.</span></span><br><span class="line">	FlushSet(set <span class="keyword">string</span>) <span class="built_in">error</span></span><br><span class="line">	<span class="comment">// DestroySet deletes a named set.</span></span><br><span class="line">	DestroySet(set <span class="keyword">string</span>) <span class="built_in">error</span></span><br><span class="line">	<span class="comment">// DestroyAllSets deletes all sets.</span></span><br><span class="line">	DestroyAllSets() <span class="built_in">error</span></span><br><span class="line">	<span class="comment">// CreateSet creates a new set.  It will ignore error when the set already exists if ignoreExistErr=true.</span></span><br><span class="line">	CreateSet(set *IPSet, ignoreExistErr <span class="keyword">bool</span>) <span class="built_in">error</span></span><br><span class="line">	<span class="comment">// AddEntry adds a new entry to the named set.  It will ignore error when the entry already exists if ignoreExistErr=true.</span></span><br><span class="line">	AddEntry(entry <span class="keyword">string</span>, set *IPSet, ignoreExistErr <span class="keyword">bool</span>) <span class="built_in">error</span></span><br><span class="line">	<span class="comment">// DelEntry deletes one entry from the named set</span></span><br><span class="line">	DelEntry(entry <span class="keyword">string</span>, set <span class="keyword">string</span>) <span class="built_in">error</span></span><br><span class="line">	<span class="comment">// Test test if an entry exists in the named set</span></span><br><span class="line">	TestEntry(entry <span class="keyword">string</span>, set <span class="keyword">string</span>) (<span class="keyword">bool</span>, <span class="built_in">error</span>)</span><br><span class="line">	<span class="comment">// ListEntries lists all the entries from a named set</span></span><br><span class="line">	ListEntries(set <span class="keyword">string</span>) ([]<span class="keyword">string</span>, <span class="built_in">error</span>)</span><br><span class="line">	<span class="comment">// ListSets list all set names from kernel</span></span><br><span class="line">	ListSets() ([]<span class="keyword">string</span>, <span class="built_in">error</span>)</span><br><span class="line">	<span class="comment">// GetVersion returns the "X.Y" version string for ipset.</span></span><br><span class="line">	GetVersion() (<span class="keyword">string</span>, <span class="built_in">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥åŠé€šè¿‡<code>ProxyMode</code>å‚æ•°è·å–åŸºäº<code>userspace</code>, <code>iptables</code>, <code>ipvs</code>ä¸‰ç§æ–¹å¼ä¸­çš„å“ªç§ä½¿ç”¨çš„<code>Proxier</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ProxyProvider is the interface provided by proxier implementations.</span></span><br><span class="line">type ProxyProvider interface &#123;</span><br><span class="line">	config.EndpointsHandler</span><br><span class="line">	config.ServiceHandler</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sync immediately synchronizes the ProxyProvider's current state to proxy rules.</span></span><br><span class="line">	Sync()</span><br><span class="line">	<span class="comment">// SyncLoop runs periodic work.</span></span><br><span class="line">	<span class="comment">// This is expected to run as a goroutine or as the main loop of the app.</span></span><br><span class="line">	<span class="comment">// It does not return.</span></span><br><span class="line">	SyncLoop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥é‡ç‚¹ä»‹ç»åŸºäº<code>ipvs</code>æ¨¡å¼å®ç°çš„<code>Proxier</code>, åœ¨<code>ipvs</code>æ¨¡å¼ä¸‹<code>Proxier</code>ç»“æ„çš„å®šä¹‰:</p>
<p>æ³¨æ„:ç”±äº<code>Proxier</code>å®šä¹‰çš„å†…å®¹å¤ªå¤š,æˆ‘è¿™é‡ŒæŠŠæ¥ä¸‹æ¥ä»‹ç»çš„å†…å®¹ä¿ç•™ï¼Œå…¶å®ƒä¸å‡†å¤‡ä»‹ç»çš„å†…å®¹åˆ é™¤æ‰ï¼Œçœçš„å ç”¨å¤ªå¤šçš„ç¯‡å¹…ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">type Proxier struct &#123;</span><br><span class="line">	endpointsChanges *proxy.EndpointChangeTracker</span><br><span class="line">	serviceChanges   *proxy.ServiceChangeTracker</span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	serviceMap   proxy.ServiceMap</span><br><span class="line">	endpointsMap proxy.EndpointsMap</span><br><span class="line">	portsMap     map[utilproxy.LocalPort]utilproxy.Closeable</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	syncRunner      *async<span class="selector-class">.BoundedFrequencyRunner</span> <span class="comment">// governs calls to syncProxyRules</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	iptables       utiliptables.Interface</span><br><span class="line">	ipvs           utilipvs.Interface</span><br><span class="line">	ipset          utilipset.Interface</span><br><span class="line">	exec           utilexec.Interface</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//...</span></span><br><span class="line">	ipvsScheduler  string</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>Proxier</code>ç»“æ„ä¸­ï¼Œå…ˆä»‹ç»ä¸‹<code>async.BoundedFrequencyRunner</code>,å…¶å®ƒçš„åœ¨ä»‹ç»<code>ProxyServer.Run</code>çš„æ—¶å€™ä»‹ç»:</p>
<p><code>BoundedFrequencyRunner</code>çš„å®šä¹‰ç»“æ„å¦‚ä¸‹:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type BoundedFrequencyRunner struct &#123;</span><br><span class="line">	name        string        <span class="comment">// the name of this instance</span></span><br><span class="line">	minInterval <span class="selector-tag">time</span><span class="selector-class">.Duration</span> <span class="comment">// the min time between runs, modulo bursts</span></span><br><span class="line">	maxInterval <span class="selector-tag">time</span><span class="selector-class">.Duration</span> <span class="comment">// the max time between runs</span></span><br><span class="line"></span><br><span class="line">	run chan struct&#123;&#125; <span class="comment">// try an async run</span></span><br><span class="line"></span><br><span class="line">	mu      sync<span class="selector-class">.Mutex</span>  <span class="comment">// guards runs of fn and all mutations</span></span><br><span class="line">	fn      func()      <span class="comment">// function to run</span></span><br><span class="line">	lastRun <span class="selector-tag">time</span><span class="selector-class">.Time</span>   <span class="comment">// time of last run</span></span><br><span class="line">	timer   timer       <span class="comment">// timer for deferred runs</span></span><br><span class="line">	limiter rateLimiter <span class="comment">// rate limiter for on-demand runs</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>BoundedFrequencyRunner</code>ç»“æ„ä¸­çš„<code>run</code>ä¼šå¼‚æ­¥çš„å»å®šæœŸçš„æ‰§è¡Œä»»åŠ¡<code>fn</code>ï¼Œæ¯”å¦‚å®šæœŸçš„æ‰§è¡Œ<code>proxier.syncProxyRules</code>å»åˆ›å»ºæˆ–è€…æ›´æ–°<code>VirtuaServer</code>å’Œ<code>RealServer</code>å¹¶å°†<code>VirtualServer</code>çš„VIPç»‘å®šåˆ°dummy interface(kube-ipvs0)ã€‚</p>
<p>ä¸‹é¢æ˜¯åœ¨<code>NewProxier</code>æ–¹æ³•ä¸­åˆå§‹åŒ–<code>BoundedFrequencyRunner</code>å¯¹è±¡çš„ç¤ºä¾‹:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxier<span class="selector-class">.syncRunner</span> = async.NewBoundedFrequencyRunner(</span><br><span class="line">    <span class="string">"sync-runner"</span>, proxier<span class="selector-class">.syncProxyRules</span>, minSyncPeriod, syncPeriod, burstSyncs)</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­:</p>
<ul>
<li>minSyncPeriod: è§„åˆ™æœ€å°çš„æ›´æ–°æ—¶é—´</li>
<li>syncPeriod: è§„åˆ™æœ€å¤§æ›´æ–°æ—¶é—´</li>
<li>proxier.syncProxyRules: åŒæ­¥è§„åˆ™çš„å®ç°å‡½æ•°(ä¹Ÿæ˜¯kube-proxyåŸºäºipvsåŒæ­¥è§„åˆ™çš„æ ¸å¿ƒå®ç°)</li>
</ul>
<p>æ¥ä¸‹æ¥ä»‹ç»ä¸‹<code>ProxyServer.Run</code>çš„é€»è¾‘å®ç°éƒ¨åˆ†:</p>
<h3 id="ProxyServerå¯åŠ¨æµç¨‹"><a href="#ProxyServerå¯åŠ¨æµç¨‹" class="headerlink" title="ProxyServerå¯åŠ¨æµç¨‹"></a>ProxyServerå¯åŠ¨æµç¨‹</h3><div align="left"><br><img src="http://p5.qhimg.com/t013c681c83e3884839.png" width="1000" height="600" alt="kube-proxy"><br></div>

<p>ä¸Šé¢è¿™å¼ å›¾æ˜¯<code>ProxyServer</code>å¯åŠ¨çš„æ•´ä¸ªæµç¨‹å›¾ã€‚åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œä¸»è¦åšäº†ä¸‹é¢è¿™å‡ ä»¶äº‹å„¿:</p>
<p>1.å¯åŠ¨å¥åº·æ£€æŸ¥æœåŠ¡<code>HealthzServer</code>.<br>2.å¯åŠ¨æš´éœ²ç›‘æ§æŒ‡æ ‡çš„<code>MetricsServer</code>.<br>3.å¦‚æœéœ€è¦è°ƒæ•´ç³»ç»Ÿçš„conntrackç›¸å…³å‚æ•°,åˆ™å¯¹ç³»ç»Ÿçš„conntrackè¿›è¡Œå‚æ•°è°ƒæ•´.<br>4.åˆ›å»ºä¸€ä¸ª<code>informerFactory</code>å®ä¾‹ï¼Œåé¢å»é€šè¿‡<code>informerFactory</code>è·å–kubernetesçš„å„ç±»èµ„æºæ•°æ®.<br>5.åˆ›å»ºä¸€ä¸ª<code>ServiceConfig</code>å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹ä¸»è¦ä½œç”¨æ˜¯å®æ—¶çš„<code>WATCH</code> kubernetes Serviceèµ„æºçš„å˜åŒ–ï¼Œå¹¶åŠ å…¥é˜Ÿåˆ—ä¸­ï¼Œç”¨äºåç»­å¯¹å˜åŒ–çš„Serviceè¿›è¡Œè§„åˆ™åŒæ­¥ã€‚<br>6.æ³¨å†Œ<code>servier event hander</code>åˆ°<code>Proxier</code>.<br>7.å¯åŠ¨serviceConfig.</p>
<p>æ¥ä¸‹æ¥è¯¦ç»†çš„ä»‹ç»ä¸‹[4-7]è¿™å‡ æ­¥çš„æµç¨‹:</p>
<p><code>ServiceConfig</code>çš„ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">ServiceConfig</span> struct &#123;</span><br><span class="line">	listerSynced  cache.<span class="type">InformerSynced</span></span><br><span class="line">	eventHandlers []<span class="type">ServiceHandler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ServiceHandler</code>çš„ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">ServiceHandler </span><span class="keyword">interface</span> &#123;</span><br><span class="line">	// OnServiceAdd <span class="keyword">is</span> called whenever creation <span class="keyword">of</span> <span class="keyword">new</span> service object</span><br><span class="line">	// <span class="keyword">is</span> observed.</span><br><span class="line">	OnServiceAdd(service *v1.Service)</span><br><span class="line">	// OnServiceUpdate <span class="keyword">is</span> called whenever modification <span class="keyword">of</span> an existing</span><br><span class="line">	// service object <span class="keyword">is</span> observed.</span><br><span class="line">	OnServiceUpdate(oldService, service *v1.Service)</span><br><span class="line">	// OnServiceDelete <span class="keyword">is</span> called whenever deletion <span class="keyword">of</span> an existing service</span><br><span class="line">	// object <span class="keyword">is</span> observed.</span><br><span class="line">	OnServiceDelete(service *v1.Service)</span><br><span class="line">	// OnServiceSynced <span class="keyword">is</span> called once <span class="keyword">all</span> the initial even handlers were</span><br><span class="line">	// called <span class="keyword">and</span> the state <span class="keyword">is</span> fully propagated to local cache.</span><br><span class="line">	OnServiceSynced()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ›å»º<code>ServiceConfig</code>å®ä¾‹å¯¹è±¡çš„å…·ä½“å®ç°å¦‚ä¸‹:</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">NewServiceConfig</span>(<span class="selector-tag">serviceInformer</span> <span class="selector-tag">coreinformers</span><span class="selector-class">.ServiceInformer</span>, <span class="selector-tag">resyncPeriod</span> <span class="selector-tag">time</span><span class="selector-class">.Duration</span>) *<span class="selector-tag">ServiceConfig</span> &#123;</span><br><span class="line">	<span class="attribute">result </span>:= &amp;ServiceConfig&#123;</span><br><span class="line">		listerSynced: serviceInformer.<span class="built_in">Informer</span>().HasSynced,</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="selector-tag">serviceInformer</span><span class="selector-class">.Informer</span>()<span class="selector-class">.AddEventHandlerWithResyncPeriod</span>(</span><br><span class="line">		<span class="selector-tag">cache</span><span class="selector-class">.ResourceEventHandlerFuncs</span>&#123;</span><br><span class="line">			<span class="attribute">AddFunc</span>:    result.handleAddService,</span><br><span class="line">			UpdateFunc: result.handleUpdateService,</span><br><span class="line">			DeleteFunc: result.handleDeleteService,</span><br><span class="line">		&#125;,</span><br><span class="line">		<span class="selector-tag">resyncPeriod</span>,</span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="selector-tag">return</span> <span class="selector-tag">result</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>é¦–å…ˆé€šè¿‡æ‰§è¡Œ<code>serviceInformer.Informer().HasSynced</code>æ¥å°†kubernetesä¸‹çš„æ‰€æœ‰Serviceèµ„æºåŒæ­¥åˆ°ç¼“å­˜<code>listerSynced</code>ä¸­ã€‚</li>
<li>å…¶æ¬¡ä¸º<code>AddEventHandlerWithResyncPeriod</code>æ·»åŠ é’ˆå¯¹<code>Service</code>å¯¹è±¡ï¼Œæ·»åŠ ï¼Œæ›´æ–°ï¼Œåˆ é™¤çš„äº‹ä»¶è§¦å‘å‡½æ•°ã€‚å½“<code>Service</code>æœ‰ç›¸åº”çš„è§¦å‘åŠ¨ä½œï¼Œå°±ä¼šè°ƒç”¨ç›¸åº”çš„å‡½æ•°:</li>
</ul>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">handleAddService</span></span><br><span class="line"><span class="attribute">handleUpdateService</span></span><br><span class="line"><span class="attribute">handleDeleteService</span></span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çœ‹çœ‹<code>handleAddService</code>è§¦å‘å‡½æ•°çš„å®ç°é€»è¾‘ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *ServiceConfig)</span> <span class="title">handleAddService</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	service, ok := obj.(*v1.Service)</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		utilruntime.HandleError(fmt.Errorf(<span class="string">"unexpected object type: %v"</span>, obj))</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="keyword">range</span> c.eventHandlers &#123;</span><br><span class="line">		klog.V(<span class="number">4</span>).Info(<span class="string">"Calling handler.OnServiceAdd"</span>)</span><br><span class="line">		c.eventHandlers[i].OnServiceAdd(service)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“watchåˆ°kubernetesé›†ç¾¤ä¸­æœ‰æ–°çš„<code>Service</code>è¢«åˆ›å»ºä¹‹åï¼Œä¼šè§¦å‘<code>handleAddService</code>å‡½æ•°ï¼Œå¹¶åœ¨è¯¥å‡½æ•°ä¸­éå†<code>eventHandlers</code>åˆ†åˆ«å»è°ƒç”¨<code>OnServiceAdd</code>æ¥å¯¹<code>proxier</code>ç»“æ„ä¸­çš„<code>serviceChanages</code>è¿›è¡Œæ›´æ–°å¹¶å»åŒæ­¥ç›¸åº”çš„è§„åˆ™ã€‚</p>
<p><code>OnServiceAdd</code>çš„å…·ä½“å®ç°é€»è¾‘å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// OnServiceAdd is called whenever creation of new service object is observed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxier *Proxier)</span> <span class="title">OnServiceAdd</span><span class="params">(service *v1.Service)</span></span> &#123;</span><br><span class="line">	proxier.OnServiceUpdate(<span class="literal">nil</span>, service)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OnServiceUpdate is called whenever modification of an existing service object is observed.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxier *Proxier)</span> <span class="title">OnServiceUpdate</span><span class="params">(oldService, service *v1.Service)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> proxier.serviceChanges.Update(oldService, service) &amp;&amp; proxier.isInitialized() &#123;</span><br><span class="line">		proxier.syncRunner.Run()</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>ServiceChangeTracker</code>çš„ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// ServiceChangeTracker carries state about uncommitted <span class="keyword">changes</span> <span class="keyword">to</span> <span class="keyword">an</span> arbitrary <span class="keyword">number</span> of</span><br><span class="line">// Services, keyed by their namespace <span class="built_in">and</span> name.</span><br><span class="line"><span class="built_in">type</span> ServiceChangeTracker struct &#123;</span><br><span class="line">	// lock protects <span class="built_in">items</span>.</span><br><span class="line">	lock <span class="keyword">sync</span>.Mutex</span><br><span class="line">	// <span class="built_in">items</span> maps <span class="keyword">a</span> service <span class="keyword">to</span> its serviceChange.</span><br><span class="line">	<span class="built_in">items</span> <span class="keyword">map</span>[types.NamespacedName]*serviceChange</span><br><span class="line">	// makeServiceInfo allows proxier <span class="keyword">to</span> inject customized information when processing service.</span><br><span class="line">	makeServiceInfo makeServicePortFunc</span><br><span class="line">	// isIPv6Mode indicates <span class="keyword">if</span> <span class="keyword">change</span> tracker <span class="keyword">is</span> under IPv6/IPv4 <span class="keyword">mode</span>. Nil means not applicable.</span><br><span class="line">	isIPv6Mode *bool</span><br><span class="line">	recorder   record.EventRecorder</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>serviceChanage</code>çš„ç»“æ„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight pf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// serviceChange contains <span class="literal">all</span> changes <span class="keyword">to</span> services that happened since proxy rules were synced.  For a single object,</span><br><span class="line">// changes are accumulated, i.e. previous is <span class="keyword">state</span> <span class="keyword">from</span> before applying the changes,</span><br><span class="line">// current is <span class="keyword">state</span> after applying <span class="literal">all</span> of the changes.</span><br><span class="line">type serviceChange struct &#123;</span><br><span class="line">	previous ServiceMap</span><br><span class="line">	current  ServiceMap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°è¿™é‡Œåœ¨å›è¿‡å¤´æ¥çœ‹ä¸Šé¢çš„åŸºäºIPVSå®ç°çš„<code>Proxier</code>çš„æ•´ä½“æµç¨‹å°±å®Œå…¨é€šäº†ï¼Œ<code>ProxyServer.Run</code>å‡½æ•°åœ¨å¯åŠ¨æ—¶ï¼Œé€šè¿‡kubernetes <code>LIST/WATCH</code>æœºåˆ¶å»å®æ—¶çš„æ„ŸçŸ¥kubernetesé›†ç¾¤<code>Service</code>èµ„æºçš„å˜åŒ–ï¼Œç„¶åä¸æ–­çš„åœ¨æ›´æ–°<code>Proxier</code>ç»“æ„ä¸­çš„<code>ServiceChanges</code>ï¼Œç„¶åå°†å˜åŒ–çš„<code>Service</code>ä¿å­˜åœ¨<code>ServiceChanges</code>ç»“æ„ä¸­çš„<code>ServiceMap</code>ä¸­ï¼Œç»™åç»­çš„<code>async.BoundedFrequencyRunner</code>å»æ‰§è¡ŒåŒæ­¥è§„åˆ™å‡½æ•°<code>syncProxyRules</code>æ¥ä½¿ç”¨ã€‚</p>
<p>8.<code>endpointConfig</code>çš„å®ç°æœºåˆ¶å’Œ<code>serviceConfig</code>çš„æœºåˆ¶å®Œå…¨ä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸åœ¨è¯¦ç»†çš„ä»‹ç»äº†ã€‚<br>9.ä¸Šé¢åšçš„æ‰€æœ‰é¢„å¤„ç†å·¥ä½œï¼Œä¼šåœ¨<code>informerFactory.Start</code>è¿™æ­¥ç”Ÿæ•ˆã€‚<br>10.<code>birthCry</code>çš„ä½œç”¨å°±æ˜¯é€šè¿‡<code>event</code>çš„æ–¹å¼é€šçŸ¥kubernetes, kube-proxyè¿™è¾¹çš„æ‰€æœ‰å‡†å¤‡å·¥ä½œéƒ½å¤„ç†å¥½äº†ï¼Œæˆ‘è¦å¯åŠ¨äº†ã€‚</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func (s *ProxyServer) birthCry() &#123;</span><br><span class="line">	s<span class="selector-class">.Recorder</span><span class="selector-class">.Eventf</span>(s<span class="selector-class">.NodeRef</span>, api<span class="selector-class">.EventTypeNormal</span>, <span class="string">"Starting"</span>, <span class="string">"Starting kube-proxy."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>11.æœ€ç»ˆé€šè¿‡<code>SyncLoop</code>å¯åŠ¨kube-proxyæœåŠ¡ï¼Œå¹¶ç«‹åˆ»æ‰§è¡Œ<code>syncProxyRules</code>å…ˆæ¥ä¸€éåŒæ­¥åœ¨è¯´.ä¹‹åä¾¿ä¼šé€šè¿‡å¼‚æ­¥çš„æ–¹å¼å®šæœŸçš„å»åŒæ­¥<code>IPVS</code>, <code>Iptables</code>, <code>Ipset</code>çš„è§„åˆ™é€šè¿‡<code>syncProxyRules</code>å‡½æ•°:</p>
<p>è€Œ<code>syncProxyRules</code>å‡½æ•°æ˜¯kube-proxyå®ç°çš„æ ¸å¿ƒã€‚ä¸»ä½“é€»è¾‘æ˜¯éå†<code>ServiceMap</code>å¹¶éå†<code>ServiceMap</code>ä¸‹çš„<code>endpointsMap</code>åŠåˆ›å»ºçš„<code>Service</code>ç±»å‹(å¦‚: CLusterIP, Loadbalancer, NodePort)å»åˆ†åˆ«åˆ›å»ºç›¸åº”çš„<code>IPVS</code>è§„åˆ™ã€‚</p>
<p><code>syncProxyRules</code>çš„å‡½æ•°å®ç°å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(proxier *Proxier)</span> <span class="title">syncProxyRules</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//.....</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Build IPVS rules for each service.</span></span><br><span class="line">	<span class="keyword">for</span> svcName, svc := <span class="keyword">range</span> proxier.serviceMap &#123;</span><br><span class="line">		<span class="comment">//......</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// Handle traffic that loops back to the originator with SNAT.</span></span><br><span class="line">		<span class="keyword">for</span> _, e := <span class="keyword">range</span> proxier.endpointsMap[svcName] &#123;</span><br><span class="line">			<span class="comment">//....</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture the clusterIP.</span></span><br><span class="line">		<span class="comment">// ipset call</span></span><br><span class="line">		entry := &amp;utilipset.Entry&#123;</span><br><span class="line">			IP:       svcInfo.ClusterIP().String(),</span><br><span class="line">			Port:     svcInfo.Port(),</span><br><span class="line">			Protocol: protocol,</span><br><span class="line">			SetType:  utilipset.HashIPPort,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// add service Cluster IP:Port to kubeServiceAccess ip set for the purpose of solving hairpin.</span></span><br><span class="line">		<span class="comment">// proxier.kubeServiceAccessSet.activeEntries.Insert(entry.String())</span></span><br><span class="line">		<span class="keyword">if</span> valid := proxier.ipsetList[kubeClusterIPSet].validateEntry(entry); !valid &#123;</span><br><span class="line">			klog.Errorf(<span class="string">"%s"</span>, fmt.Sprintf(EntryInvalidErr, entry, proxier.ipsetList[kubeClusterIPSet].Name))</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		proxier.ipsetList[kubeClusterIPSet].activeEntries.Insert(entry.String())</span><br><span class="line">		<span class="comment">// ipvs call</span></span><br><span class="line">		serv := &amp;utilipvs.VirtualServer&#123;</span><br><span class="line">			Address:   svcInfo.ClusterIP(),</span><br><span class="line">			Port:      <span class="keyword">uint16</span>(svcInfo.Port()),</span><br><span class="line">			Protocol:  <span class="keyword">string</span>(svcInfo.Protocol()),</span><br><span class="line">			Scheduler: proxier.ipvsScheduler,</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Set session affinity flag and timeout for IPVS service</span></span><br><span class="line">		<span class="keyword">if</span> svcInfo.SessionAffinityType() == v1.ServiceAffinityClientIP &#123;</span><br><span class="line">			serv.Flags |= utilipvs.FlagPersistent</span><br><span class="line">			serv.Timeout = <span class="keyword">uint32</span>(svcInfo.StickyMaxAgeSeconds())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// We need to bind ClusterIP to dummy interface, so set `bindAddr` parameter to `true` in syncService()</span></span><br><span class="line">		<span class="keyword">if</span> err := proxier.syncService(svcNameString, serv, <span class="literal">true</span>); err == <span class="literal">nil</span> &#123;</span><br><span class="line">			activeIPVSServices[serv.String()] = <span class="literal">true</span></span><br><span class="line">			activeBindAddrs[serv.Address.String()] = <span class="literal">true</span></span><br><span class="line">			<span class="comment">// ExternalTrafficPolicy only works for NodePort and external LB traffic, does not affect ClusterIP</span></span><br><span class="line">			<span class="comment">// So we still need clusterIP rules in onlyNodeLocalEndpoints mode.</span></span><br><span class="line">			<span class="keyword">if</span> err := proxier.syncEndpoint(svcName, <span class="literal">false</span>, serv); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				klog.Errorf(<span class="string">"Failed to sync endpoint for service: %v, err: %v"</span>, serv, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			klog.Errorf(<span class="string">"Failed to sync service: %v, err: %v"</span>, serv, err)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture externalIPs.</span></span><br><span class="line">		<span class="keyword">for</span> _, externalIP := <span class="keyword">range</span> svcInfo.ExternalIPStrings() &#123;</span><br><span class="line">			<span class="comment">//....</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Capture load-balancer ingress.</span></span><br><span class="line">		<span class="keyword">for</span> _, ingress := <span class="keyword">range</span> svcInfo.LoadBalancerIPStrings() &#123;</span><br><span class="line">			<span class="comment">//.....</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> svcInfo.NodePort() != <span class="number">0</span> &#123;</span><br><span class="line">			<span class="comment">//....</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// sync ipset entries</span></span><br><span class="line">	<span class="keyword">for</span> _, set := <span class="keyword">range</span> proxier.ipsetList &#123;</span><br><span class="line">		set.syncIPSetEntries()</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Tail call iptables rules for ipset, make sure only call iptables once</span></span><br><span class="line">	<span class="comment">// in a single loop per ip set.</span></span><br><span class="line">	proxier.writeIptablesRules()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Sync iptables rules.</span></span><br><span class="line">	<span class="comment">// <span class="doctag">NOTE:</span> NoFlushTables is used so we don't flush non-kubernetes chains in the table.</span></span><br><span class="line">	proxier.iptablesData.Reset()</span><br><span class="line">	proxier.iptablesData.Write(proxier.natChains.Bytes())</span><br><span class="line">	proxier.iptablesData.Write(proxier.natRules.Bytes())</span><br><span class="line">	proxier.iptablesData.Write(proxier.filterChains.Bytes())</span><br><span class="line">	proxier.iptablesData.Write(proxier.filterRules.Bytes())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>kube-proxyçš„ä»£ç é€»è¾‘è¿˜æ˜¯æ¯”è¾ƒç®€æ´çš„ï¼Œæ•´ä½“çš„æ€æƒ³å°±æ˜¯kube-proxyæœåŠ¡å»watch kubernetesé›†ç¾¤çš„<code>Service</code>å’Œ<code>Endpoint</code>å¯¹è±¡ï¼Œå½“è¿™ä¸¤ä¸ªèµ„æºå¯¹è±¡æœ‰çŠ¶æ€å˜åŒ–æ—¶ï¼Œä¼šæŠŠå®ƒä»¬ä¿å­˜åœ¨<code>ServiceMap</code>å’Œ<code>EndPonintMap</code>ä¸­ï¼Œç„¶åä¼šé€šè¿‡<code>async.BoundedFrequencyRunner</code>å»å¼‚æ­¥çš„æ‰§è¡Œ<code>syncProxyRules</code>å»ä¸‹å‘è§„åˆ™ã€‚</p>
</div><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/ipvs/">ipvs</a><a href="/tags/iptables/">iptables</a><a href="/tags/netfilter/">netfilter</a></div><div class="post-nav"><a class="pre" href="/2019/08/22/dns/">A DNS Refresher</a><a class="next" href="/2019/07/21/kubernetes-service/">æµ…è°ˆKubernetes Serviceè´Ÿè½½å‡è¡¡å®ç°æœºåˆ¶</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '86d1945e3a9358946043',
  clientSecret: '304f48ee3394ae5dab75d19a966506e170d850f6',
  repo: 'xigang.github.io',
  owner: 'xigang',
  admin: ['xigang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://github.com/xigang"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/etcd/">etcd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservices/">microservices</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ—¥å¿—ç›‘æ§/">æ—¥å¿—ç›‘æ§</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœºå™¨å­¦ä¹ /">æœºå™¨å­¦ä¹ </a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kapacitor/" style="font-size: 15px;">kapacitor</a> <a href="/tags/alertmanager/" style="font-size: 15px;">alertmanager</a> <a href="/tags/bosun/" style="font-size: 15px;">bosun</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/cgroup/" style="font-size: 15px;">cgroup</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/dns/" style="font-size: 15px;">dns</a> <a href="/tags/coredns/" style="font-size: 15px;">coredns</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/prometheus/" style="font-size: 15px;">prometheus</a> <a href="/tags/kubeflow/" style="font-size: 15px;">kubeflow</a> <a href="/tags/scheduler/" style="font-size: 15px;">scheduler</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kube-dns/" style="font-size: 15px;">kube-dns</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a> <a href="/tags/ipvs/" style="font-size: 15px;">ipvs</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/netfilter/" style="font-size: 15px;">netfilter</a> <a href="/tags/lxcfs/" style="font-size: 15px;">lxcfs</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/02/10/k8s-namespace/">A Namespace Is Stuck in the Terminating State</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/12/27/statefulset-controller/">Kube-Controller-managerä¹‹StatefulSet Controlleræºç è§£æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/23/kube-apisever/">Kube-apiseverå¯åŠ¨æµç¨‹åŠAPIå®‰è£…æºç åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/11/09/lxcfs-admission-webhook/">ä½¿ç”¨Lxcfså’Œkubernetes Admission Webhookå®ç°å¯¹å®¹å™¨èµ„æºå¯è§†åŒ–éš”ç¦»</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/10/11/etcd-cluster-on-kubernetes/">Etcd Cluster on Kubernetes</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/21/client-go/">Kubernetes Client-Go Informer å®ç°æºç å‰–æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/25/coredns/">CoreDNSæºç åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/22/dns/">A DNS Refresher</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/28/kube-proxy-source-code/">Kube-Proxy  IPVSæ¨¡å¼æºç åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/kubernetes-service/">æµ…è°ˆKubernetes Serviceè´Ÿè½½å‡è¡¡å®ç°æœºåˆ¶</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2020 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>