<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>CoreDNSæºç åˆ†æ | xigang's home</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">CoreDNSæºç åˆ†æ</h1><a id="logo" href="/.">xigang's home</a><p class="description">Do it right or don't do it at all</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a><a href="/atom.xml"><i class="fa fa-rss"> è®¢é˜…</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">CoreDNSæºç åˆ†æ</h1><div class="post-meta">Aug 25, 2019<span> | </span><span class="category"><a href="/categories/network/">network</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> é˜…è¯»</span></span></div><div class="post-content"><p>åœ¨Kubernetes 1.13ç‰ˆæœ¬ä»¥å(åŒ…å«1.13),Kubernetesä¾¿æŒ‡å®šäº†CoreDNSä½œä¸ºé»˜è®¤çš„æœåŠ¡å‘ç°æœºåˆ¶(ä¹‹å‰é»˜è®¤çš„ç‰ˆæœ¬æ˜¯<a href="https://xigang.github.io/2018/11/24/kube-dns/" target="_blank" rel="noopener">Kube-DNS</a>)ï¼Œç”±äºé¡¹ç›®ä¸­ä¹Ÿéœ€è¦ä½¿ç”¨CoreDNSå¯¹Serviceè¿›è¡ŒDNSè§£æï¼Œæ‰€ä»¥åœ¨ä½¿ç”¨CoreDNSçš„è¿‡ç¨‹ï¼Œä¾¿æ·±å…¥çš„çœ‹ä¸‹CoreDNSçš„æºç ï¼Œå·²å¯¹å…¶å†…éƒ¨çš„å®ç°æœºåˆ¶æœ‰æ‰€äº†è§£ã€‚</p>
<p>CoreDNSç‰ˆæœ¬: CoreDNS-1.6.2</p>
<h3 id="CoreDNS-çš„å®‰è£…åŠä½¿ç”¨"><a href="#CoreDNS-çš„å®‰è£…åŠä½¿ç”¨" class="headerlink" title="CoreDNS çš„å®‰è£…åŠä½¿ç”¨"></a>CoreDNS çš„å®‰è£…åŠä½¿ç”¨</h3><p>å¯¹äºCoreDNSçš„å®‰è£…åŠä½¿ç”¨æ–¹å¼è¿™é‡Œå°±ä¸åšè¯¦ç»†çš„ä»‹ç»äº†ï¼Œå…·ä½“è¯¦æƒ…è¯·å‚è€ƒ:</p>
<ul>
<li><a href="https://github.com/kubernetes/kubernetes/tree/master/cluster/addons/dns/coredns">Install CoreDNS</a></li>
<li><a href="https://coredns.io/manual/toc/" target="_blank" rel="noopener">How to use CoreDNS?</a></li>
</ul>
<h3 id="CoreDNS-æºç åˆ†æ"><a href="#CoreDNS-æºç åˆ†æ" class="headerlink" title="CoreDNS æºç åˆ†æ"></a>CoreDNS æºç åˆ†æ</h3><p>CoreDNSæ˜¯ä¸€ä¸ªåŸºäº<a href="https://github.com/caddyserver/caddy">caddy</a>æ¡†æ¶å®ç°çš„ï¼Œæ•´ä¸ªé¡¹ç›®å¤§é‡çš„ä½¿ç”¨äº†Caddyçš„æ’ä»¶åŠŸèƒ½ï¼Œæ¥ä¸‹æ¥ç›´æ¥åˆ†ææºç ï¼Œä¸‹é¢è¿™å¼ å›¾(å›¾ç‰‡æºè‡ªç½‘ç»œ)å°±æ˜¯CoreDNSæ•´ä½“æ¡†æ¶å¯åŠ¨æµç¨‹çš„ä¸€ä¸ªç»“æ„:</p>
<div align="left"><br><img src="http://p1.qhimg.com/t01d78be440cfa6b4fd.png" width="800" height="800" alt="coredns"><br></div>

<p>é¦–å…ˆåœ¨CoreDNSçš„main.goæ–‡ä»¶ä¸­ï¼Œä¼šå¯¹plugin packageè¿›è¡Œimportï¼Œç”¨æ¥å°†æ‰€æœ‰çš„pluginè¿›è¡Œregisterã€‚</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="comment">// Plug in CoreDNS</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/core/plugin"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸‹<code>github.com/coredns/coredns/core/plugin/zplugin.go</code>æ–‡ä»¶çš„å†…å®¹(éœ€è¦æ³¨æ„çš„æ˜¯<code>zplugin.go</code>æ–‡ä»¶æ˜¯Makefileé€šè¿‡<code>plugin.cfg</code>è‡ªåŠ¨ç”Ÿæˆçš„, è€ŒCoreDNSä¼šåŸºäº<code>plugin.cfg</code>æ–‡ä»¶ä¸­çš„æŒ‡ä»¤é¡ºåºï¼ŒæŒ‰é¡ºåºè¿›è¡Œæ’ä»¶çš„æ‰§è¡Œ)ã€‚</p>
<p>Makefileé€šè¿‡<code>plugin.cfg</code>ç”Ÿæˆçš„æŒ‡ä»¤å¦‚ä¸‹:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">core/plugin/zplugin<span class="selector-class">.go</span> core/dnsserver/zdirectives<span class="selector-class">.go</span>: plugin<span class="selector-class">.cfg</span> GO111MODULE=on go generate coredns.go</span><br></pre></td></tr></table></figure>
<p><code>zplugin.go</code>æ–‡ä»¶çš„å†…å®¹å¦‚ä¸‹:</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// generated by directives_generate.go; DO NOT EDIT</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> plugin</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="comment">// Include all plugins.</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/caddyserver/caddy/onevent"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/any"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/auto"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/autopath"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/azure"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/bind"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/cache"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/cancel"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/chaos"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/debug"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/dnssec"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/dnstap"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/erratic"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/errors"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/etcd"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/federation"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/file"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/forward"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/grpc"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/health"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/hosts"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/k8s_external"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/kubernetes"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/loadbalance"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/log"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/loop"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/metadata"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/metrics"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/nsid"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/pprof"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/ready"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/reload"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/rewrite"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/root"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/route53"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/secondary"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/template"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/tls"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/trace"</span></span><br><span class="line">	<span class="literal">_</span> <span class="string">"github.com/coredns/coredns/plugin/whoami"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>åœ¨plugin packageä¸­çš„æ¯ä¸€ä¸ªpluginçš„init()éƒ½ä¼šåœ¨ç¨‹åºå¯åŠ¨ä¹‹å‰è¢«æ‰§è¡Œï¼Œè¿›è¡Œpluginçš„æ³¨å†Œã€‚è®©æˆ‘ä»¬æ¥çœ‹kuernetes pluginçš„æ³¨å†Œè¿‡ç¨‹:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">init</span>() &#123;</span><br><span class="line">	<span class="selector-tag">caddy</span><span class="selector-class">.RegisterPlugin</span>(<span class="string">"kubernetes"</span>, caddy.Plugin&#123;</span><br><span class="line">		<span class="attribute">ServerType</span>: <span class="string">"dns"</span>,</span><br><span class="line">		<span class="attribute">Action</span>:     setup,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>caddy.Pluginç»“æ„åŒ…å«äº†è¢«æ³¨å†Œçš„pluginçš„åŸºæœ¬ä¿¡æ¯,åŒ…æ‹¬æ³¨å†Œçš„æœåŠ¡ç±»å‹(åœ¨CoreDNSä¸­çš„æœåŠ¡ç±»å‹æ˜¯<code>dns</code>)å’Œè¯·æ±‚è¿™ä¸ªpluginæ—¶,è¿™ä¸ªpluginè¯¥åšçš„Actionã€‚</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Plugin <span class="keyword">is</span> a <span class="keyword">type</span> <span class="type">which </span>holds information about a plugin.</span><br><span class="line"><span class="keyword">type</span> <span class="type">Plugin </span>struct &#123;</span><br><span class="line">	// ServerType <span class="keyword">is</span> the <span class="keyword">type</span> <span class="type">of </span>server this plugin <span class="keyword">is</span> <span class="keyword">for</span>.</span><br><span class="line">	// Can be empty <span class="keyword">if</span> <span class="keyword">not</span> applicable, <span class="keyword">or</span> <span class="keyword">if</span> the plugin</span><br><span class="line">	// can associate <span class="keyword">with</span> any server <span class="keyword">type</span>.</span><br><span class="line">	ServerType string</span><br><span class="line"></span><br><span class="line">	// Action <span class="keyword">is</span> the plugin<span class="symbol">'s</span> setup <span class="keyword">function</span>, <span class="keyword">if</span> associated</span><br><span class="line">	// <span class="keyword">with</span> a directive <span class="keyword">in</span> the Caddyfile.</span><br><span class="line">	Action SetupFunc</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>caddy.RegisterPluginæ–¹æ³•çš„ä½œç”¨:</p>
<p>å°†æŒ‡å®šplugin name(æœ¬ç¤ºä¾‹:kubernetes)æ³¨å†Œåˆ°æœåŠ¡ç±»å‹ä¸ºDNSçš„CoreDNSæœåŠ¡ä¸­ã€‚æœ€ç»ˆæ‰€æœ‰è¢«æ³¨å†Œpluginçš„å­˜å‚¨ç»“æ„ä¸º:</p>
<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// plugins <span class="keyword">is</span> a <span class="keyword">map</span> <span class="keyword">of</span> server <span class="keyword">type</span> <span class="keyword">to</span> <span class="keyword">map</span> <span class="keyword">of</span> plugin name <span class="keyword">to</span></span><br><span class="line">// Plugin. These are the <span class="string">"general"</span> plugins that may <span class="keyword">or</span> may</span><br><span class="line">// <span class="keyword">not</span> be associated <span class="keyword">with</span> a specific server <span class="keyword">type</span>. <span class="keyword">If</span> it<span class="symbol">'s</span></span><br><span class="line">// applicable <span class="keyword">to</span> multiple server types <span class="keyword">or</span> the server <span class="keyword">type</span> <span class="keyword">is</span></span><br><span class="line">// irrelevant, the key <span class="keyword">is</span> empty <span class="built_in">string</span> (<span class="string">""</span>). But <span class="keyword">all</span> plugins</span><br><span class="line">// must have a name.</span><br><span class="line">plugins = make(<span class="keyword">map</span>[<span class="built_in">string</span>]<span class="keyword">map</span>[<span class="built_in">string</span>]Plugin)</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œé€šè¿‡ä¸Šé¢çš„è¿™ä¸ªè¿‡ç¨‹å°±æŠŠCoreDNSéœ€è¦çš„æ‰€æœ‰çš„pluginéƒ½æ³¨å†Œåˆ°äº†<code>plugins = make(map[string]map[string]Plugin)</code>ç»“æ„ä¸­ï¼Œç”¨äºåç»­çš„ä½¿ç”¨ã€‚</p>
<p>æ³¨å†Œå®Œæ‰€æœ‰çš„pluginä¹‹å,å¼€å§‹æ‰§è¡Œmainæ–¹æ³•,è¯¥æ–¹æ³•å¾ˆç®€æ´ï¼Œåªä¼šå»è°ƒç”¨ä¸€ä¸ª<code>coremain.Run()</code>æ–¹æ³•ï¼Œåœ¨run.goæ–‡ä»¶çš„import packageä¸­ä¼šå­˜åœ¨ä¸€ä¸ªå¦‚ä¸‹çš„package:</p>
<figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (<span class="string">"github.com/coredns/coredns/core/dnsserver"</span>)</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªpackageä¼šå‘CoreDNSæ³¨å†Œä¸€ä¸ªå«åš<code>dns</code>çš„æœåŠ¡ç±»å‹ï¼Œå¹¶å…³è”ä¸è¿™ä¸ª<code>dns</code>æœåŠ¡ç±»å‹ç›¸å…³çš„ä¸€äº›æ“ä½œ:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	flag.StringVar(&amp;Port, serverType+<span class="string">".port"</span>, DefaultPort, <span class="string">"Default port"</span>)</span><br><span class="line"></span><br><span class="line">	caddy.RegisterServerType(serverType, caddy.ServerType&#123;</span><br><span class="line">		Directives: <span class="function"><span class="keyword">func</span><span class="params">()</span> []<span class="title">string</span></span> &#123; <span class="keyword">return</span> Directives &#125;,</span><br><span class="line">		DefaultInput: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">caddy</span>.<span class="title">Input</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> caddy.CaddyfileInput&#123;</span><br><span class="line">				Filepath:       <span class="string">"Corefile"</span>,</span><br><span class="line">				Contents:       []<span class="keyword">byte</span>(<span class="string">".:"</span> + Port + <span class="string">" &#123;\nwhoami\n&#125;\n"</span>),</span><br><span class="line">				ServerTypeName: serverType,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;,</span><br><span class="line">		NewContext: newContext,</span><br><span class="line">	&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>caddy.ServerTypeåŒ…å«ä¸€äº›æœåŠ¡ç±»å‹ç›¸å…³çš„ä¿¡æ¯ã€‚åŒ…æ‹¬:</p>
<ul>
<li>ä¸€ä¸ªæŒ‡ä»¤åˆ—è¡¨çš„å‡½æ•°å£°æ˜,è¿™ä¸ªæŒ‡ä»¤åˆ—è¡¨å®šä¹‰åœ¨<code>github.com/coredns/coredns/core/dnsserver/zdirectives.go</code>æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ä¹Ÿæ˜¯é€šè¿‡Makefileçš„æ–¹å¼è‡ªåŠ¨ç”Ÿæˆã€‚å¹¶æŒ‰ç…§æŒ‡ä»¤ç±»åˆ«çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚</li>
<li>ä¸€ä¸ªåŠ è½½é»˜è®¤Corefileé»˜è®¤é…ç½®æ–‡ä»¶çš„å‡½æ•°å£°æ˜ï¼ˆinputä¸­åŒ…å«äº†é…ç½®æ–‡ä»¶çš„<code>å†…å®¹</code>ï¼Œ <code>è·¯å¾„</code>ä»¥åŠæ‰€å±çš„æœåŠ¡ç±»å‹ç­‰ä¿¡æ¯ï¼‰</li>
<li>ä¸€ä¸ªç”¨äºæœåŠ¡å®ä¾‹å¯åŠ¨çš„Contextå‡½æ•°å£°æ˜</li>
</ul>
<p>å…·ä½“çš„å®šä¹‰å¦‚ä¸‹ç»“æ„:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServerType contains information about a server type.</span></span><br><span class="line">type <span class="type">ServerType</span> <span class="class"><span class="keyword">struct</span> </span>&#123;</span><br><span class="line">	<span class="comment">// Function that returns the list of directives, in</span></span><br><span class="line">	<span class="comment">// execution order, that are valid for this server</span></span><br><span class="line">	<span class="comment">// type. Directives should be one word if possible</span></span><br><span class="line">	<span class="comment">// and lower-cased.</span></span><br><span class="line">	<span class="type">Directives</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> []string</span><br><span class="line"></span><br><span class="line">	<span class="comment">// DefaultInput returns a default config input if none</span></span><br><span class="line">	<span class="comment">// is otherwise loaded. This is optional, but highly</span></span><br><span class="line">	<span class="comment">// recommended, otherwise a blank Caddyfile will be</span></span><br><span class="line">	<span class="comment">// used.</span></span><br><span class="line">	<span class="type">DefaultInput</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> <span class="type">Input</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The function that produces a new server type context.</span></span><br><span class="line">	<span class="comment">// This will be called when a new Caddyfile is being</span></span><br><span class="line">	<span class="comment">// loaded, parsed, and executed independently of any</span></span><br><span class="line">	<span class="comment">// startup phases before this one. It's a way to keep</span></span><br><span class="line">	<span class="comment">// each set of server instances separate and to reduce</span></span><br><span class="line">	<span class="comment">// the amount of global state you need.</span></span><br><span class="line">	<span class="type">NewContext</span> <span class="function"><span class="keyword">func</span><span class="params">(inst *Instance)</span></span> <span class="type">Context</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“caddy.ServerTypeåˆå§‹åŒ–å®Œæˆä¹‹åï¼Œä¼šé€šè¿‡caddy.RegisterServerTypeå‘CoreDNSè¿›è¡ŒæœåŠ¡ç±»å‹ä¸º<code>dns</code>çš„æœåŠ¡æ³¨å†Œ,å¹¶å°†æœåŠ¡ç±»å‹æ³¨å†Œåˆ°å¦‚ä¸‹ç»“æ„:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// serverTypes is a map of registered server types.</span></span><br><span class="line">serverTypes = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]ServerType)</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢ä»‹ç»çš„è¿™äº›éƒ½æ˜¯CoreDNSæœåŠ¡åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­çš„åˆå§‹åŒ–å·¥ä½œã€‚go on</p>
<p>åœ¨<code>Run()</code>ä¸­ä¼šæ‰§è¡Œ:</p>
<figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">corefile,</span> err := caddy.LoadCaddyfile(serverType)</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨å°±æ˜¯åŠ è½½<code>Corefile</code>é…ç½®æ–‡ä»¶ï¼Œå¹¶å°†é…ç½®æ–‡ä»¶çš„å†…å®¹è§£æåˆ°å¦‚ä¸‹çš„ç»“æ„ä¸­ç”¨äºåç»­æœåŠ¡çš„ä½¿ç”¨:</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">type Input <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Gets the Caddyfile contents</span></span><br><span class="line">	Body() []<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Gets the path to the origin file</span></span><br><span class="line">	Path() <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// The type of server this input is intended for</span></span><br><span class="line">	ServerType() <span class="keyword">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŠ è½½å®ŒæˆCorefileä¹‹åï¼Œæ¥ä¸‹æ¥å°±å¼€å§‹å¯åŠ¨engineäº† ğŸ˜‹ã€‚</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">instance</span>, err := caddy.<span class="type">Start</span>(<span class="title">corefile</span>)</span></span><br></pre></td></tr></table></figure>
<p>Startå‡½æ•°ä¼šç­‰æ‰€æœ‰éœ€è¦çš„æœåŠ¡éƒ½LISTENä¹‹åï¼Œæ‰ä¼šè¿”å›ï¼Œå¦è€…ä¼šä¸€ç›´block, å…·ä½“å®šä¹‰å¦‚ä¸‹æ‰€ç¤º:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Start</span><span class="params">(cdyfile Input)</span> <span class="params">(*Instance, error)</span></span> &#123;</span><br><span class="line">	inst := &amp;Instance&#123;serverType: cdyfile.ServerType(), wg: <span class="built_in">new</span>(sync.WaitGroup), Storage: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;)&#125;</span><br><span class="line">	err := startWithListenerFds(cdyfile, inst, <span class="literal">nil</span>)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> inst, err</span><br><span class="line">	&#125;</span><br><span class="line">	signalSuccessToParent()</span><br><span class="line">	<span class="keyword">if</span> pidErr := writePidFile(); pidErr != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"[ERROR] Could not write pidfile: %v"</span>, pidErr)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Execute instantiation events</span></span><br><span class="line">	EmitEvent(InstanceStartupEvent, inst)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> inst, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Startå‡½æ•°ä¼šè¿”å›ä¸€ä¸ª<code>Instance</code>çš„ç»“æ„ï¼Œè¯¥ç»“æ„ä¸­ä¿å­˜äº†ä¸€äº›æœåŠ¡çš„çŠ¶æ€ï¼Œç”¨äºæœåŠ¡çš„å¯åŠ¨ã€‚</p>
<p>Instanceç»“æ„çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">type <span class="type">Instance</span> <span class="class"><span class="keyword">struct</span> </span>&#123;</span><br><span class="line">	<span class="comment">// serverType is the name of the instance's server type</span></span><br><span class="line">	serverType string</span><br><span class="line"></span><br><span class="line">	<span class="comment">// caddyfileInput is the input configuration text used for this process</span></span><br><span class="line">	caddyfileInput <span class="type">Input</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// wg is used to wait for all servers to shut down</span></span><br><span class="line">	wg *sync.<span class="type">WaitGroup</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// context is the context created for this instance,</span></span><br><span class="line">	<span class="comment">// used to coordinate the setting up of the server type</span></span><br><span class="line">	context <span class="type">Context</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// servers is the list of servers with their listeners</span></span><br><span class="line">	servers []<span class="type">ServerListener</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// these callbacks execute when certain events occur</span></span><br><span class="line">	<span class="type">OnFirstStartup</span>  []<span class="function"><span class="keyword">func</span><span class="params">()</span></span> error <span class="comment">// starting, not as part of a restart</span></span><br><span class="line">	<span class="type">OnStartup</span>       []<span class="function"><span class="keyword">func</span><span class="params">()</span></span> error <span class="comment">// starting, even as part of a restart</span></span><br><span class="line">	<span class="type">OnRestart</span>       []<span class="function"><span class="keyword">func</span><span class="params">()</span></span> error <span class="comment">// before restart commences</span></span><br><span class="line">	<span class="type">OnRestartFailed</span> []<span class="function"><span class="keyword">func</span><span class="params">()</span></span> error <span class="comment">// if restart failed</span></span><br><span class="line">	<span class="type">OnShutdown</span>      []<span class="function"><span class="keyword">func</span><span class="params">()</span></span> error <span class="comment">// stopping, even as part of a restart</span></span><br><span class="line">	<span class="type">OnFinalShutdown</span> []<span class="function"><span class="keyword">func</span><span class="params">()</span></span> error <span class="comment">// stopping, not as part of a restart</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// storing values on an instance is preferable to</span></span><br><span class="line">	<span class="comment">// global state because these will get garbage-</span></span><br><span class="line">	<span class="comment">// collected after in-process reloads when the</span></span><br><span class="line">	<span class="comment">// old instances are destroyed; use StorageMu</span></span><br><span class="line">	<span class="comment">// to access this value safely</span></span><br><span class="line">	<span class="type">Storage</span>   <span class="built_in">map</span>[interface&#123;&#125;]interface&#123;&#125;</span><br><span class="line">	<span class="type">StorageMu</span> sync.<span class="type">RWMutex</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>serverType:è¡¨ç¤ºè¯¥Instanceè¢«å…³è”åˆ°å…·ä½“å“ªä¸€ä¸ªæœåŠ¡ç±»å‹,åœ¨æˆ‘ä»¬è¿™é‡Œæ˜¯<code>dns</code>ã€‚</li>
<li>caddyfileInput: å·²ç»è¢«åŠ è½½çš„corefileæ–‡ä»¶çš„å†…å®¹ã€‚</li>
<li>context: å¯åŠ¨æœåŠ¡ä½¿ç”¨çš„ä¸€äº›contextå†…å®¹ã€‚</li>
<li><p>servers: è¯¥instanceéœ€è¦å¯åŠ¨çš„æœåŠ¡åˆ—è¡¨(åœ¨æˆ‘ä»¬è¿™é‡Œä¸»è¦æ˜¯TCPå’ŒUDPæœåŠ¡)ã€‚</p>
<p>  å…¶å®ƒçš„å°±æ˜¯ä¸€ä¸ªpluginæ³¨å†Œåˆ°æœåŠ¡çš„å¯åŠ¨å›è°ƒå‡½æ•°(callbacks)ï¼Œå½“æœåŠ¡å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»æ ¹æ®ä¸åŒçš„pluginåŠ è½½å…·ä½“çš„å¯åŠ¨callbackå‡½æ•°ã€‚</p>
</li>
</ul>
<p>å¥½äº†ï¼Œè®©æˆ‘ä»¬ç»§ç»­å›åˆ°Startå‡½æ•°çš„å®šä¹‰ä¸­, åœ¨è¯¥å‡½æ•°ä¸­ä¸»è¦è°ƒç”¨ä¸‰ä¸ªå‡½æ•°åˆ†åˆ«æ˜¯:</p>
<ul>
<li>startWithListenerFds: ç”¨äºè§£æCorefileé…ç½®æ–‡ä»¶åŠæ ¡éªŒæŒ‡ä»¤æ‰§è¡Œçš„æ˜¯å¦æ­£ç¡®ï¼Œå¹¶å¯åŠ¨CoreDNSæœåŠ¡ã€‚</li>
<li>signalSuccessToParent: å‘çˆ¶è¿›ç¨‹æŠ¥å‘ŠæœåŠ¡å¯åŠ¨çŠ¶æ€ã€‚</li>
<li>writePidFile: å°†å¯åŠ¨æœåŠ¡çš„è¿›ç¨‹ID(PID)å†™å…¥åˆ°æŒ‡å®šçš„æ–‡ä»¶ã€‚</li>
</ul>
<p>ä»ä¸Šé¢çš„è§£é‡Šä¸­å³å¯çŸ¥é“startWithListenerFdsæ˜¯æœ€ä¸ºæ ¸å¿ƒçš„å‡½æ•°è°ƒç”¨äº†ï¼Œæ¥ä¸‹æ¥ç›´æ¥è¯¦ç»†çš„åˆ†æstartWithListenerFdså‡½æ•°ã€‚åœ¨è¯¥å‡½æ•°ä¸­é¦–å…ˆä¼šè°ƒç”¨</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">loadServerBlocks</span>(stypeName, cdyfile.<span class="type">Path</span>(), bytes.<span class="type">NewReader</span>(cdyfile.<span class="type">Body</span>()))`</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯åŠ è½½Corefileæ–‡ä»¶çš„å†…å®¹ï¼Œå¹¶è§£æè¯¥æ–‡ä»¶çš„å†…å®¹åˆ°<code>ServerBlock</code>ç»“æ„:</p>
<figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">ServerBlock</span> struct &#123;</span><br><span class="line">	<span class="type">Keys</span>   []string</span><br><span class="line">	<span class="type">Tokens</span> map[string][]<span class="type">Token</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„keysä¸»è¦ç”¨äºå­˜å‚¨Corefileæ–‡ä»¶ä¸­çš„Zoneç›¸å…³çš„æ•°æ®(æ¯”å¦‚: serverçš„åœ°å€åŠç«¯å£å·ç­‰)ï¼Œè€ŒTokensç”¨äºå­˜å‚¨è¯¥serverä¸‹é¢çš„pluginçš„ä¿¡æ¯ï¼Œå…¶ä¸­Tokensçš„keyæ˜¯plugin name, []Tokenå­˜å‚¨çš„æ˜¯è¯¥pluginåœ¨Corefileä¸­çš„ä½ç½®ï¼Œä¾¿äºåç»­çš„è§£ææ“ä½œã€‚</p>
<p>ä¹‹åä¼šè°ƒç”¨NewContextå¯¹instanceçš„Contextè¿›è¡Œåˆå§‹åŒ–ã€‚ç„¶åé€šè¿‡è¯¥Contextå®ä¾‹åˆ†åˆ«å»è°ƒç”¨:</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Context</span> <span class="selector-tag">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Called after the Caddyfile is parsed into server</span></span><br><span class="line">	<span class="comment">// blocks but before the directives are executed,</span></span><br><span class="line">	<span class="comment">// this method gives you an opportunity to inspect</span></span><br><span class="line">	<span class="comment">// the server blocks and prepare for the execution</span></span><br><span class="line">	<span class="comment">// of directives. Return the server blocks (which</span></span><br><span class="line">	<span class="comment">// you may modify, if desired) and an error, if any.</span></span><br><span class="line">	<span class="comment">// The first argument is the name or path to the</span></span><br><span class="line">	<span class="comment">// configuration file (Caddyfile).</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// This function can be a no-op and simply return its</span></span><br><span class="line">	<span class="comment">// input if there is nothing to do here.</span></span><br><span class="line">	<span class="selector-tag">InspectServerBlocks</span>(string, []caddyfile.ServerBlock) ([]caddyfile.ServerBlock, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// This is what Caddy calls to make server instances.</span></span><br><span class="line">	<span class="comment">// By this time, all directives have been executed and,</span></span><br><span class="line">	<span class="comment">// presumably, the context has enough state to produce</span></span><br><span class="line">	<span class="comment">// server instances for Caddy to start.</span></span><br><span class="line">	<span class="selector-tag">MakeServers</span>() ([]Server, error)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>ValidateAndExecuteDirectives</code>å‡½æ•°ä¸­åªè°ƒç”¨äº†<code>InspectServerBlocks</code>,è¿™ä¸ªå‡½æ•°ä¼šåœ¨è§£æå®ŒCorefileæ–‡ä»¶ä¹‹åï¼Œæ‰§è¡ŒCorefileä¸­çš„æŒ‡ä»¤ä¹‹å‰ä¼šè¢«è°ƒç”¨ï¼Œç”¨äºè¿›ä¸€æ­¥çš„å¯¹serverblockè¿›è¡Œæ£€æŸ¥å¹¶è¿›è¡Œè¿›ä¸€æ­¥çš„å‚æ•°å®Œå–„ã€‚</p>
<p>ç­‰ä¸Šé¢çš„å‡†å¤‡å·¥ä½œå‡†å¤‡å®Œæˆä¹‹åï¼Œä¼šè°ƒç”¨<code>executeDirectives</code>å»éå†æ‰€æœ‰çš„æŒ‡ä»¤<code>directives</code>,å¦‚æœserverblockä¸­çš„æŒ‡ä»¤åœ¨<code>directives</code>,åˆ™è®¾ç½®ç›¸åº”çš„Controllerå»æ‰§è¡Œç›¸å…³pluginçš„actionåŠ¨ä½œ:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">executeDirectives</span><span class="params">(inst *Instance, filename <span class="keyword">string</span>, directives []<span class="keyword">string</span>, sblocks []caddyfile.ServerBlock, justValidate <span class="keyword">bool</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="comment">// a directive for all server blocks before going to the next directive.</span></span><br><span class="line">	<span class="comment">// This is important mainly due to the parsing callbacks (below).</span></span><br><span class="line">	<span class="keyword">for</span> _, dir := <span class="keyword">range</span> directives &#123;</span><br><span class="line">		<span class="keyword">for</span> i, sb := <span class="keyword">range</span> sblocks &#123;</span><br><span class="line">			<span class="keyword">for</span> j, key := <span class="keyword">range</span> sb.Keys &#123;</span><br><span class="line">				<span class="comment">// Execute directive if it is in the server block</span></span><br><span class="line">				<span class="keyword">if</span> tokens, ok := sb.Tokens[dir]; ok &#123;</span><br><span class="line">					controller := &amp;Controller&#123;</span><br><span class="line">						instance:  inst,</span><br><span class="line">						Key:       key,</span><br><span class="line">						Dispenser: caddyfile.NewDispenserTokens(filename, tokens),</span><br><span class="line">						OncePerServerBlock: <span class="function"><span class="keyword">func</span><span class="params">(f <span class="keyword">func</span>()</span> <span class="title">error</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">							<span class="keyword">var</span> err error</span><br><span class="line">							once.Do(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">								err = f()</span><br><span class="line">							&#125;)</span><br><span class="line">							<span class="keyword">return</span> err</span><br><span class="line">						&#125;,</span><br><span class="line">						ServerBlockIndex:    i,</span><br><span class="line">						ServerBlockKeyIndex: j,</span><br><span class="line">						ServerBlockKeys:     sb.Keys,</span><br><span class="line">						ServerBlockStorage:  storages[i][dir],</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					setup, err := DirectiveAction(inst.serverType, dir)</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> err</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					err = setup(controller)</span><br><span class="line">					<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="keyword">return</span> err</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					storages[i][dir] = controller.ServerBlockStorage <span class="comment">// persist for this server block</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>ValidateAndExecuteDirectives</code>å‡½æ•°çš„è¿›ä¸€æ­¥å¯¹Corefileè§£æï¼Œå¹¶é€šè¿‡è§£æè¿‡çš„å„ä¸ªpluginè¿›è¡Œæ‰§è¡Œä¹‹åï¼ŒCorefileæ–‡ä»¶ä¸­å®šä¹‰çš„ç›¸å…³çš„pluginæ’ä»¶åŸºæœ¬éƒ½å·²å¤„äºå‡†å¤‡å¥½çš„çŠ¶æ€ã€‚</p>
<p>æ¥ä¸‹æ¥è°ƒç”¨dnsContextçš„MakeServersæ–¹æ³•ï¼Œç”¨äºå¯åŠ¨CoreDNSæœåŠ¡ï¼Œæ¥æ”¶å¤–éƒ¨çš„è¯·æ±‚ã€‚ä¸‹é¢æ˜¯MakeServersçš„å‡½æ•°å®šä¹‰:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(h *dnsContext)</span> <span class="title">MakeServers</span><span class="params">()</span> <span class="params">([]caddy.Server, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line"> .......</span><br><span class="line">	<span class="comment">// we must map (group) each config to a bind address</span></span><br><span class="line">	groups, err := groupConfigsByListenAddr(h.configs)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// then we create a server for each group</span></span><br><span class="line">	<span class="keyword">var</span> servers []caddy.Server</span><br><span class="line">	<span class="keyword">for</span> addr, group := <span class="keyword">range</span> groups &#123;</span><br><span class="line">		<span class="comment">// switch on addr</span></span><br><span class="line">		<span class="keyword">switch</span> tr, _ := parse.Transport(addr); tr &#123;</span><br><span class="line">		<span class="keyword">case</span> transport.DNS:</span><br><span class="line">			s, err := NewServer(addr, group)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			servers = <span class="built_in">append</span>(servers, s)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> transport.TLS:</span><br><span class="line">			s, err := NewServerTLS(addr, group)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			servers = <span class="built_in">append</span>(servers, s)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> transport.GRPC:</span><br><span class="line">			s, err := NewServergRPC(addr, group)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			servers = <span class="built_in">append</span>(servers, s)</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> transport.HTTPS:</span><br><span class="line">			s, err := NewServerHTTPS(addr, group)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			servers = <span class="built_in">append</span>(servers, s)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> servers, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨MakeServerså‡½æ•°ä¸­é¦–å…ˆä¼šè°ƒç”¨:groupConfigsByListenAddrç”¨äºå°†ä¸åŒserverä¸‹çš„é…ç½®è¿›è¡Œåˆ†ç»„ã€‚å¹¶è¿”å›ä¸€ä¸ªmapï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">groupConfigsByListenAddr</span><span class="params">(configs []*Config)</span> <span class="params">(<span class="keyword">map</span>[<span class="keyword">string</span>][]*Config, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">	groups := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>][]*Config)</span><br><span class="line">	<span class="keyword">for</span> _, conf := <span class="keyword">range</span> configs &#123;</span><br><span class="line">		<span class="keyword">for</span> _, h := <span class="keyword">range</span> conf.ListenHosts &#123;</span><br><span class="line">			addr, err := net.ResolveTCPAddr(<span class="string">"tcp"</span>, net.JoinHostPort(h, conf.Port))</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">			&#125;</span><br><span class="line">			addrstr := conf.Transport + <span class="string">"://"</span> + addr.String()</span><br><span class="line">			groups[addrstr] = <span class="built_in">append</span>(groups[addrstr], conf)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> groups, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­è¿”å›çš„mapä¸­ï¼Œkeyè¡¨ç¤ºçš„æ˜¯æœåŠ¡çš„åœ°å€ï¼Œvalueè¡¨ç¤ºä¸è¯¥æœåŠ¡ç›¸å…³çš„é…ç½®ä¿¡æ¯ã€‚</p>
<p>ä¹‹åéå†è¯¥map, ç„¶åæ ¹æ®ä¸åŒçš„transportå»å¯åŠ¨ç›¸åº”çš„æœåŠ¡ï¼Œå½“å‰CoreDNSæ”¯æŒ4ç§ç±»å‹çš„transport:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const (</span><br><span class="line"><span class="built_in">	DNS </span>  = <span class="string">"dns"</span></span><br><span class="line">	TLS   = <span class="string">"tls"</span></span><br><span class="line">	GRPC  = <span class="string">"grpc"</span></span><br><span class="line">	HTTPS = <span class="string">"https"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>æ— è®ºæ˜¯å“ªä¸€ç§ç±»å‹çš„transportæœ€ç»ˆéƒ½ä¼šå»æ‰§è¡Œ<code>NewServer</code>å‡½æ•°ã€‚<code>NewServer</code>ä¼šè¿”å›ä¸€äº›CoreDNS server:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ype Server struct &#123;</span><br><span class="line">	Addr string <span class="comment">// Address we listen on</span></span><br><span class="line"></span><br><span class="line">	server [<span class="number">2</span>]*dns<span class="selector-class">.Server</span> <span class="comment">// 0 is a net.Listener, 1 is a net.PacketConn (a *UDPConn) in our case.</span></span><br><span class="line">	m      sync<span class="selector-class">.Mutex</span>     <span class="comment">// protects the servers</span></span><br><span class="line"></span><br><span class="line">	zones        map[string]*Config <span class="comment">// zones keyed by their address</span></span><br><span class="line">	dnsWg        sync<span class="selector-class">.WaitGroup</span>     <span class="comment">// used to wait on outstanding connections</span></span><br><span class="line">	graceTimeout <span class="selector-tag">time</span><span class="selector-class">.Duration</span>      <span class="comment">// the maximum duration of a graceful shutdown</span></span><br><span class="line">	trace        trace<span class="selector-class">.Trace</span>        <span class="comment">// the trace plugin for the server</span></span><br><span class="line">	debug        bool               <span class="comment">// disable recover()</span></span><br><span class="line">	classChaos   bool               <span class="comment">// allow non-INET class queries</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢åªæ˜¯makeäº†CoreDNSéœ€è¦å¯åŠ¨çš„<code>Server</code>ç»“æ„,ä½†æ˜¯çœŸæ­£çš„æœåŠ¡è¿›ç¨‹åˆ°ç°åœ¨è¿™ä¸ªé˜¶æ®µè¿˜æ²¡æœ‰çœŸæ­£çš„å¯åŠ¨ã€‚</p>
<p>æ¥ä¸‹æ¥çš„æ“ä½œæ˜¯é€šè¿‡ä¸‹é¢çš„è¿™éƒ¨åˆ†ä»£ç æ¥å¯¹å·²ç»æ³¨å†Œçš„å„ä¸ªpluginè¿›è¡Œå¯åŠ¨æ“ä½œï¼Œä¹Ÿå°±æ˜¯åœ¨æ¯ä¸ªpluginä¼šåœ¨è¿›è¡Œ<code>setup</code>çš„æ—¶å€™ï¼ŒæŒ‡å®šç›¸å…³çš„å›è°ƒå‡½æ•°(callback)ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢ä»‹ç»<code>Instance</code>ç»“æ„çš„æ—¶å€™ï¼Œä»‹ç»çš„å“ªäº›å›è°ƒå‡½æ•°(callback)ã€‚</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> _, startupFunc := <span class="keyword">range</span> inst.OnStartup &#123;</span><br><span class="line">		<span class="keyword">err</span> = startupFunc()</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">err</span> != nil &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">err</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æ‰€æœ‰çš„pluginéœ€è¦çš„å‡†å¤‡å·¥ä½œéƒ½å¤„ç†å®Œæˆä¹‹åï¼Œå°±è°ƒç”¨<code>startServers</code>æ¥å¯åŠ¨CoreDNSæœåŠ¡,<code>startServers</code>å‡½æ•°çš„å®šä¹‰å¦‚ä¸‹:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">startServers</span><span class="params">(serverList []Server, inst *Instance, restartFds <span class="keyword">map</span>[<span class="keyword">string</span>]restartTriple)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> serverList &#123;</span><br><span class="line">		<span class="keyword">if</span> ln == <span class="literal">nil</span> &#123;</span><br><span class="line">			ln, err = s.Listen()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"Listen: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> pc == <span class="literal">nil</span> &#123;</span><br><span class="line">			pc, err = s.ListenPacket()</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> fmt.Errorf(<span class="string">"ListenPacket: %v"</span>, err)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		inst.servers = <span class="built_in">append</span>(inst.servers, ServerListener&#123;server: s, listener: ln, packet: pc&#125;)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, s := <span class="keyword">range</span> inst.servers &#123;</span><br><span class="line">		inst.wg.Add(<span class="number">2</span>)</span><br><span class="line">		stopWg.Add(<span class="number">2</span>)</span><br><span class="line">		<span class="function"><span class="keyword">func</span><span class="params">(s Server, ln net.Listener, pc net.PacketConn, inst *Instance)</span></span> &#123;</span><br><span class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					inst.wg.Done()</span><br><span class="line">					stopWg.Done()</span><br><span class="line">				&#125;()</span><br><span class="line">				errChan &lt;- s.Serve(ln)</span><br><span class="line">			&#125;()</span><br><span class="line"></span><br><span class="line">			<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">				<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">					inst.wg.Done()</span><br><span class="line">					stopWg.Done()</span><br><span class="line">				&#125;()</span><br><span class="line">				errChan &lt;- s.ServePacket(pc)</span><br><span class="line">			&#125;()</span><br><span class="line">		&#125;(s.server, s.listener, s.packet, inst)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Log errors that may be returned from Serve() calls,</span></span><br><span class="line">	<span class="comment">// these errors should only be occurring in the server loop.</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">for</span> &#123;</span><br><span class="line">			<span class="keyword">select</span> &#123;</span><br><span class="line">			<span class="keyword">case</span> err := &lt;-errChan:</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> !strings.Contains(err.Error(), <span class="string">"use of closed network connection"</span>) &#123;</span><br><span class="line">						<span class="comment">// this error is normal when closing the listener; see https://github.com/golang/go/issues/4373</span></span><br><span class="line">						log.Println(err)</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">case</span> &lt;-stopChan:</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		stopWg.Wait()</span><br><span class="line">		stopChan &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>startServers</code>å‡½æ•°ä¸­å»éå†serverListå»åˆ†åˆ«å¯åŠ¨<code>TCP</code>å’Œ<code>UDP</code>æœåŠ¡ã€‚ç”¨äºæ¥æ”¶å¤–éƒ¨çš„DNSè¯·æ±‚ã€‚</p>
<p>æœ€å,caddy.Wait()ä¸»è¿›ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œcaddyå¼€å§‹å¤„ç†æ¥æ”¶åˆ°çš„è¯·æ±‚ï¼Œè¿™é‡Œçš„æ¯ä¸ªè¯·æ±‚éƒ½ä¼šå‘é€ç»™<code>core/dnsserver/server.go</code>çš„ServerDNSå¤„ç†ï¼Œè¿™é‡Œæ˜¯DNSçš„æ€»é€»è¾‘ã€‚</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeDNS is the entry point for every request to the address that s</span></span><br><span class="line"><span class="comment">// is bound to. It acts as a multiplexer for the requests zonename as</span></span><br><span class="line"><span class="comment">// defined in the request so that the correct zone</span></span><br><span class="line"><span class="comment">// (configuration and plugin stack) will handle the request.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span> <span class="title">ServeDNS</span><span class="params">(ctx context.Context, w dns.ResponseWriter, r *dns.Msg)</span></span> &#123;</span><br><span class="line">	<span class="comment">// The default dns.Mux checks the question section size, but we have our</span></span><br><span class="line">	<span class="comment">// own mux here. Check if we have a question section. If not drop them here.</span></span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wrap the response writer in a ScrubWriter so we automatically make the reply fit in the client's buffer.</span></span><br><span class="line">	w = request.NewScrubWriter(r, w)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		l := <span class="built_in">len</span>(q[off:])</span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; l; i++ &#123;</span><br><span class="line">			b[i] = q[off+i]</span><br><span class="line">			<span class="comment">// normalize the name for the lookup</span></span><br><span class="line">			<span class="keyword">if</span> b[i] &gt;= <span class="string">'A'</span> &amp;&amp; b[i] &lt;= <span class="string">'Z'</span> &#123;</span><br><span class="line">				b[i] |= (<span class="string">'a'</span> - <span class="string">'A'</span>)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> h, ok := s.zones[<span class="keyword">string</span>(b[:l])]; ok &#123;</span><br><span class="line">			<span class="keyword">if</span> r.Question[<span class="number">0</span>].Qtype != dns.TypeDS &#123;</span><br><span class="line">				<span class="keyword">if</span> h.FilterFunc == <span class="literal">nil</span> &#123;</span><br><span class="line">					rcode, _ := h.pluginChain.ServeDNS(ctx, w, r)</span><br><span class="line">					<span class="keyword">if</span> !plugin.ClientWrite(rcode) &#123;</span><br><span class="line">						errorFunc(s.Addr, w, r, rcode)</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				<span class="comment">// FilterFunc is set, call it to see if we should use this handler.</span></span><br><span class="line">				<span class="comment">// This is given to full query name.</span></span><br><span class="line">				<span class="keyword">if</span> h.FilterFunc(q) &#123;</span><br><span class="line">					rcode, _ := h.pluginChain.ServeDNS(ctx, w, r)</span><br><span class="line">					<span class="keyword">if</span> !plugin.ClientWrite(rcode) &#123;</span><br><span class="line">						errorFunc(s.Addr, w, r, rcode)</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// The type is DS, keep the handler, but keep on searching as maybe we are serving</span></span><br><span class="line">			<span class="comment">// the parent as well and the DS should be routed to it - this will probably *misroute* DS</span></span><br><span class="line">			<span class="comment">// queries to a possibly grand parent, but there is no way for us to know at this point</span></span><br><span class="line">			<span class="comment">// if there is an actually delegation from grandparent -&gt; parent -&gt; zone.</span></span><br><span class="line">			<span class="comment">// In all fairness: direct DS queries should not be needed.</span></span><br><span class="line">			dshandler = h</span><br><span class="line">		&#125;</span><br><span class="line">		off, end = dns.NextLabel(q, off)</span><br><span class="line">		<span class="keyword">if</span> end &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> r.Question[<span class="number">0</span>].Qtype == dns.TypeDS &amp;&amp; dshandler != <span class="literal">nil</span> &amp;&amp; dshandler.pluginChain != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="comment">// DS request, and we found a zone, use the handler for the query.</span></span><br><span class="line">		rcode, _ := dshandler.pluginChain.ServeDNS(ctx, w, r)</span><br><span class="line">		<span class="keyword">if</span> !plugin.ClientWrite(rcode) &#123;</span><br><span class="line">			errorFunc(s.Addr, w, r, rcode)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Wildcard match, if we have found nothing try the root zone as a last resort.</span></span><br><span class="line">	<span class="keyword">if</span> h, ok := s.zones[<span class="string">"."</span>]; ok &amp;&amp; h.pluginChain != <span class="literal">nil</span> &#123;</span><br><span class="line">		rcode, _ := h.pluginChain.ServeDNS(ctx, w, r)</span><br><span class="line">		<span class="keyword">if</span> !plugin.ClientWrite(rcode) &#123;</span><br><span class="line">			errorFunc(s.Addr, w, r, rcode)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>éå†dns.NextLabel(dns)ï¼Œæ‰¾åˆ°åŒ¹é…çš„Zone,å¦‚æœéƒ½ä¸åŒ¹é…,åˆ™å°è¯•é»˜è®¤çš„Zone(â€œ.â€)</li>
<li>è°ƒåŠ¨zone.pluginChain.ServerDNS()è¿›è¡Œå¤„ç†ï¼ŒpluginChainæ˜¯ä¸€ä¸ªé“¾ï¼Œé“¾çš„é¡ºé¡ºåºæ˜¯<code>core/dnsserver/zdirectives.go</code>ä¸­å®šä¹‰çš„ï¼ŒæŒ‰å®šä¹‰çš„é¡ºåºä¾æ¬¡æ‰§è¡Œã€‚(ä¸Šé¢å·²ç»æåˆ°è¿‡äº†ï¼šï¼‰)</li>
</ul>
<p>æ³¨æ„:æ¯ä¸€ä¸ªæ’ä»¶éƒ½éœ€è¦å®ç°å¦‚æœè¿™ä¸ªInterface:</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type Handler<span class="built_in"> interface </span>&#123;</span><br><span class="line">		ServeDNS(context.Context, dns.ResponseWriter, <span class="number">*d</span>ns.Msg) (int, error)</span><br><span class="line">		Name() string</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>ServeDNS</code>æ˜¯æ’ä»¶å®ç°çš„æ ¸å¿ƒé€»è¾‘ï¼Œ<code>Name()</code>æ˜¯æ’ä»¶çš„åç§°ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>è¿™æ ·CoreDNSæ•´ä½“çš„ä¸€ä¸ªæ¶æ„æµç¨‹å°±å·²ç»åˆ†æå®Œäº†ï¼Œè¯´CoreDNSæœåŠ¡æœ‰ä»€ä¹ˆæ–°çš„äº®ç‚¹å…¶å®ä¹Ÿæ²¡äº®ç‚¹ï¼Œä¸»è¦å°±ä¾èµ–äºcaddyçš„æ’ä»¶åŒ–æ–¹æ¡ˆå§ï¼Œä½†æ˜¯ç°åœ¨æœ‰å¾ˆå¤šmiddlewareçš„web serveråº”è¯¥éƒ½èƒ½æ»¡è¶³è¿™ä¸ªéœ€æ±‚ï¼Œå“ˆå“ˆã€‚å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åªæ˜¯åˆ†æäº†CoreDNSçš„æ•´ä½“ç»“æ„ï¼Œä½†æ²¡æœ‰å¯¹å…¶å†…éƒ¨çš„å„ç±»æ’ä»¶è¿›è¡Œç»†åŒ–çš„åˆ†æï¼Œä¾‹å¦‚: kubernetes, forward, healthç­‰ã€‚å…³äºCoreDNSçš„å†…ç½®æ’ä»¶ï¼Œæ¥ä¸‹æ¥å¯èƒ½ä¼šæœ‰ç¯‡æ–‡ç« æ¥é’ˆå¯¹kubernetesæ’ä»¶è¿›è¡Œåˆ†æï¼šï¼‰</p>
</div><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/dns/">dns</a><a href="/tags/coredns/">coredns</a><a href="/tags/network/">network</a></div><div class="post-nav"><a class="next" href="/2019/08/22/dns/">A DNS Refresher</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.0"></script><script>var gitalk = new Gitalk({
  clientID: '86d1945e3a9358946043',
  clientSecret: '304f48ee3394ae5dab75d19a966506e170d850f6',
  repo: 'xigang.github.io',
  owner: 'xigang',
  admin: ['xigang'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="https://github.com/xigang"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/docker/">docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/etcd/">etcd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/kubernetes/">kubernetes</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/microservices/">microservices</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/æ—¥å¿—ç›‘æ§/">æ—¥å¿—ç›‘æ§</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/æœºå™¨å­¦ä¹ /">æœºå™¨å­¦ä¹ </a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/coredns/" style="font-size: 15px;">coredns</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/kapacitor/" style="font-size: 15px;">kapacitor</a> <a href="/tags/alertmanager/" style="font-size: 15px;">alertmanager</a> <a href="/tags/bosun/" style="font-size: 15px;">bosun</a> <a href="/tags/ceph/" style="font-size: 15px;">ceph</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/cgroup/" style="font-size: 15px;">cgroup</a> <a href="/tags/kernel/" style="font-size: 15px;">kernel</a> <a href="/tags/etcd/" style="font-size: 15px;">etcd</a> <a href="/tags/dns/" style="font-size: 15px;">dns</a> <a href="/tags/prometheus/" style="font-size: 15px;">prometheus</a> <a href="/tags/network/" style="font-size: 15px;">network</a> <a href="/tags/microservices/" style="font-size: 15px;">microservices</a> <a href="/tags/kubeflow/" style="font-size: 15px;">kubeflow</a> <a href="/tags/scheduler/" style="font-size: 15px;">scheduler</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/kube-dns/" style="font-size: 15px;">kube-dns</a> <a href="/tags/ipvs/" style="font-size: 15px;">ipvs</a> <a href="/tags/iptables/" style="font-size: 15px;">iptables</a> <a href="/tags/netfilter/" style="font-size: 15px;">netfilter</a> <a href="/tags/mxnet/" style="font-size: 15px;">mxnet</a> <a href="/tags/tensorflow/" style="font-size: 15px;">tensorflow</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/08/25/coredns/">CoreDNSæºç åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/22/dns/">A DNS Refresher</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/28/kube-proxy-source-code/">Kube-Proxy  IPVSæ¨¡å¼æºç åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/21/kubernetes-service/">æµ…è°ˆKubernetes Serviceè´Ÿè½½å‡è¡¡å®ç°æœºåˆ¶</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/01/cgroupv2/">CGROUPS VERSION 2</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/11/bosun/">PrometheusåŸºäºbosunæ¡†æ¶è¿›è¡Œå‘Šè­¦</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/09/container-resource-metrics/">A Deep Dive Into Kubernetes Metrics - Container Resource Metrics</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/03/15/metrics-servere/">Kubernetes Metrics-Serverä»‹ç»åŠæºç åˆ†æ</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/02/17/gang-scheduler/">é€‚åˆAIåœºæ™¯çš„è°ƒåº¦å™¨ - Gang-Schedule</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/30/tensorflow/">Tensorflowç»“åˆkubeflowè¿›è¡Œåˆ†å¸ƒå¼è®­ç»ƒ</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div><ul></ul><a href="http://gogap.cn/" title="gogap" target="_blank">gogap</a><ul></ul><a href="http://www.0x7c00.net/" title="31744" target="_blank">31744</a><ul></ul><a href="https://www.opsdev.cn/" title="360opsdev" target="_blank">360opsdev</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2019 <a href="/." rel="nofollow">xigang's home.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>